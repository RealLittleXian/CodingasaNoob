(this.webpackJsonp=this.webpackJsonp||[]).push([[14],{"2376e903be":function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return d}));var n=r("d7c625d1f2"),i=r("9fb5ff8c6f"),o=r("5d64cf765d"),a=function(){function e(e,t,r,n){var i,a=this;this.mode=e,this.proxyCursor=t,this.direction=r,this.engineAspects=n,this.delete=void 0,this.update=void 0,e!==o.j.READ_ONLY&&(this.delete=function(){return a.getProxyCursorWithMode().delete()},this.update=function(e){return a.getProxyCursorWithMode().update(e)}),(null===(i=this.engineAspects)||void 0===i?void 0:i.cursor)&&this.applyAspectPatch()}return e.prototype[Symbol.asyncIterator]=function(){return new s(this)},e.prototype.next=function(){return Object(n.__awaiter)(this,void 0,void 0,(function(){var e;return Object(n.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.proxyCursor.continue()];case 1:return(e=t.sent())?(this.proxyCursor=e,[2,this]):[2,null]}}))}))},e.prototype.value=function(){return this.proxyCursor.value},e.prototype.getProxyCursorWithMode=function(){return this.proxyCursor},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.cursor;if(this.mode!==o.j.READ_ONLY){null==t||t.delete.patch(this,"delete"),null==t||t.update.patch(this,"update")}null==t||t.next.patch(this,"next"),null==t||t.value.patch(this,"value")},e}(),s=function(){function e(e){this.currentCursor=e}return e.prototype[Symbol.asyncIterator]=function(){return this},e.prototype.next=function(){return Object(n.__awaiter)(this,void 0,void 0,(function(){var e,t;return Object(n.__generator)(this,(function(r){switch(r.label){case 0:return this.currentCursor?(e=this.currentCursor.value(),t=this,[4,this.currentCursor.next()]):[2,{value:void 0,done:!0}];case 1:return t.currentCursor=r.sent(),[2,{value:e,done:!1}]}}))}))},e}(),c=function(){function e(e,t,r,n){this.table=e,this.proxyIndex=t,this.mode=r,this.engineAspects=n,this.name=t.name,this.keyPath=t.keyPath,this.unique=t.unique,(null==n?void 0:n.index)&&this.applyAspectPatch()}return e.prototype.getAll=function(e){return this.proxyIndex.getAll(e)},e.prototype.getAllKeys=function(e,t){return this.proxyIndex.getAllKeys(e,t)},e.prototype.get=function(e){return this.proxyIndex.get(e)},e.prototype.openCursor=function(e,t){return Object(n.__awaiter)(this,void 0,void 0,(function(){var r;return Object(n.__generator)(this,(function(n){switch(n.label){case 0:return[4,this.proxyIndex.openCursor(e,t)];case 1:return(r=n.sent())?[2,new a(this.mode,r,null!=t?t:"next")]:[2,null]}}))}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.index,r=this;null==t||t.get.patch(r,"get"),null==t||t.getAll.patch(r,"getAll"),null==t||t.getAllKeys.patch(r,"getAllKeys"),null==t||t.openCursor.patch(r,"openCursor")},e}(),u=function(){function e(e,t,r,i){this.mode=e,this.objectStore=t,this.engineAspects=r,this.transaction=i,this.createIndex=void 0,this.delete=void 0,this.bulkDelete=void 0,this.clear=void 0,this.insert=void 0,this.upsert=void 0,this.deleteIndex=void 0,this.bulkUpsert=void 0,this.keyPath=t.keyPath,this.autoIncrement=t.autoIncrement,this.tableName=t.name,this.indexNames=Object(n.__spreadArray)([],Object(n.__read)(t.indexNames)),this.initWriteFun(e),(null==r?void 0:r.table)&&this.applyAspectPatch()}return e.prototype.query=function(){throw new Error("query Method is not support for IDB.")},e.prototype.supports=function(e){return!["query","bulkDelete"].includes(e)},e.prototype.index=function(e){var t=this.objectStore.index(e);return new c(this,t,this.mode,this.engineAspects)},e.prototype.getAll=function(e){return this.objectStore.getAll(e)},e.prototype.getAllKeys=function(e,t){return this.objectStore.getAllKeys(e,t)},e.prototype.get=function(e){var t;return null!==(t=this.objectStore.get(e))&&void 0!==t?t:null},e.prototype.openCursor=function(e,t){return Object(n.__awaiter)(this,void 0,void 0,(function(){var r;return Object(n.__generator)(this,(function(n){switch(n.label){case 0:return[4,this.objectStore.openCursor(e,t)];case 1:return(r=n.sent())?[2,new a(this.mode,r,null!=t?t:"next")]:[2,null]}}))}))},e.prototype.initWriteFun=function(e){var t=this;e===o.j.VERSION_CHANGE&&(this.createIndex=this.createIndexFun,this.deleteIndex=function(e){return t.getProxyObjectStoreWithMode().deleteIndex(e)}),e!==o.j.READ_ONLY&&(this.delete=function(e){return t.getProxyObjectStoreWithMode().delete(e)},this.bulkDelete=function(e){throw new Error("bulkDelete Method is not support for IDB.")},this.clear=function(){return t.getProxyObjectStoreWithMode().clear()},this.insert=function(e){return t.getProxyObjectStoreWithMode().add(e)},this.upsert=function(e){return t.getProxyObjectStoreWithMode().put(e)},this.bulkUpsert=function(e){var r=t.getProxyObjectStoreWithMode(),n=e.reduce((function(e,t){return e.push(r.put(t)),e}),[]);return Promise.all(n)})},e.prototype.createIndexFun=function(e,t,r){var n=this.getProxyObjectStoreWithMode();return new c(this,n.createIndex(e,t,r),this.mode)},e.prototype.getProxyObjectStoreWithMode=function(){return this.objectStore},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.table;if(this.mode===o.j.READ_ONLY)return null==t||t.get.patch(this,"get"),null==t||t.getAll.patch(this,"getAll"),null==t||t.getAllKeys.patch(this,"getAllKeys"),null==t||t.index.patch(this,"index"),void(null==t||t.openCursor.patch(this,"openCursor"));this.mode===o.j.VERSION_CHANGE&&(null==t||t.createIndex.patch(this,"createIndex"),null==t||t.deleteIndex.patch(this,"deleteIndex")),null==t||t.delete.patch(this,"delete"),null==t||t.insert.patch(this,"insert"),null==t||t.upsert.patch(this,"upsert"),null==t||t.bulkUpsert.patch(this,"bulkUpsert"),null==t||t.clear.patch(this,"clear")},e}(),l=function(){function e(e,t){this.proxyTransaction=e,this.engineAspects=t,this.tables=e.objectStoreNames,this.mode=e.mode,(null==t?void 0:t.transaction)&&this.applyAspectPatch()}return e.prototype.table=function(e){var t=this.proxyTransaction.objectStore(e);return new u(this.mode,t,this.engineAspects,this)},e.prototype.commit=function(){return Object(n.__awaiter)(this,void 0,void 0,(function(){return Object(n.__generator)(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.proxyTransaction.done];case 1:return e.sent(),[3,3];case 2:return e.sent(),[2,!1];case 3:return[2,!0]}}))}))},e.prototype.rollback=function(){return Object(n.__awaiter)(this,void 0,void 0,(function(){return Object(n.__generator)(this,(function(e){switch(e.label){case 0:return e.trys.push([0,1,,6]),this.proxyTransaction.abort(),[3,6];case 1:e.sent(),e.label=2;case 2:return e.trys.push([2,4,,5]),[4,this.proxyTransaction.done];case 3:return e.sent(),[3,5];case 4:return e.sent(),[2,!0];case 5:return[2,!1];case 6:return[2,!0]}}))}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.transaction,r=this;null==t||t.commit.patch(r,"commit"),null==t||t.rollback.patch(r,"rollback"),null==t||t.table.patch(r,"table")},e}(),h=function(){function e(e,t){this.idbDatabase=e,this.engineAspect=t,this.name=e.name,this.version=e.version,this.tableNames=Object(n.__spreadArray)([],Object(n.__read)(e.objectStoreNames)),this.engineAspect&&this.applyAspectPatch()}return e.prototype.setVersionChangeListener=function(e){this.idbDatabase.addEventListener("versionchange",(function(t){e(t.oldVersion,t.newVersion)}))},e.prototype.close=function(){this.idbDatabase.close()},e.prototype.createTable=function(e,t){var r=this.idbDatabase.createObjectStore(e,t);return new u(o.j.VERSION_CHANGE,r)},e.prototype.deleteTable=function(e){this.idbDatabase.deleteObjectStore(e)},e.prototype.transaction=function(e,t){var r=this.idbDatabase.transaction(e,t);return new l(r,this.engineAspect)},e.prototype.table=function(e,t){return Object(n.__awaiter)(this,void 0,void 0,(function(){var r,i,o;return Object(n.__generator)(this,(function(n){return r=this.idbDatabase.transaction([e],t),i=new l(r),o=r.objectStore(e),[2,new u(t,o,this.engineAspect,i)]}))}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspect)||void 0===e?void 0:e.database;null==t||t.deleteTable.patch(this,"deleteTable"),null==t||t.createTable.patch(this,"createTable"),null==t||t.transaction.patch(this,"transaction"),null==t||t.table.patch(this,"table"),null==t||t.close.patch(this,"close")},e}();var p=function(e,t){var r=typeof e,n=typeof t;if(isNaN(e)||isNaN(t))return indexedDB.cmp(e,t);if(r===n){if("number"===r||"bigint"===r)return e-t;if("string"===r)return function(e,t){return e<t?-1:+(e>t)}(e,t)}return e instanceof Date&&t instanceof Date?e.getTime()-t.getTime():indexedDB.cmp(e,t)},f=r("7b66f04f1e").a.withDefaultMessage("IndexedDB is missing in global context. Consider using `indexeddbshim` for better compatibility or `fake-indexeddb` in your test environment."),d=function(){function e(){if("undefined"==typeof indexedDB)throw new f;this.cmp=p}return e.prototype.deleteDB=function(e){return Object(n.__awaiter)(this,void 0,void 0,(function(){return Object(n.__generator)(this,(function(t){return[2,i.a(e)]}))}))},e.prototype.setAspects=function(e){this.engineAspects=e,this.engineAspects.openDB.patch(this,"openDB"),this.engineAspects.deleteDB.patch(this,"deleteDB")},e.prototype.openDB=function(e,t,r,o){return Object(n.__awaiter)(this,void 0,void 0,(function(){var t,a=this;return Object(n.__generator)(this,(function(n){switch(n.label){case 0:return[4,i.b(e,r,{upgrade:function(e,t,r,n){var i;null===(i=null==o?void 0:o.upgrade)||void 0===i||i.call(o,new h(e,a.engineAspects),t,r,new l(n))},blocked:function(){var e;return null===(e=null==o?void 0:o.blocked)||void 0===e?void 0:e.call(o)},blocking:function(){var e;return null===(e=null==o?void 0:o.blocking)||void 0===e?void 0:e.call(o)},terminated:function(){var e;return null===(e=null==o?void 0:o.terminated)||void 0===e?void 0:e.call(o)}})];case 1:return t=n.sent(),[2,new h(t,this.engineAspects)]}}))}))},e}()},"2a19a81d63":function(e,t,r){"use strict";r.d(t,"b",(function(){return h})),r.d(t,"a",(function(){return f}));var n,i=r("d7c625d1f2"),o=r("7b66f04f1e"),a=o.a.withMessageCreator("UnexpectedModifierError",(function(e){return'unexpected error occurred at the "'+e+'" stage of the plugable function, there may be a bug in your modifiers.'})),s=o.a.withMessageCreator("InvalidPatchedFunctionError",(function(e){return'patched target is not a function, patched key is "'+e+'"'}));!function(e){e.before="before",e.around="around",e.return="return",e.throw="throw",e.after="after",e.protect="protect"}(n||(n={}));var c=function(){function e(e){this.modifiers={before:[],around:[],return:[],throw:[],after:[],protect:[]},this.createContext=e}return e.prototype.before=function(e){return this.modifiers.before.push(e),this},e.prototype.around=function(e){return this.modifiers.around.push(e),this},e.prototype.throw=function(e){return this.modifiers.throw.push(e),this},e.prototype.return=function(e){return this.modifiers.return.push(e),this},e.prototype.after=function(e){return this.modifiers.after.push(e),this},e.prototype.protect=function(e){return this.modifiers.protect.push(e),this},e.prototype.patch=function(e,t){Object.defineProperty(e,t,{enumerable:!1,value:this.compile(e,t),writable:!0,configurable:!0})},e.prototype.dirty=function(){return Object.values(this.modifiers).some((function(e){return e.length}))},e.prototype.compile=function(e,t){var r=e[t];if("function"!=typeof r)throw new s(t);var n=this.invoke.bind(this);return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n(r,this,e)}},e}(),u=c,l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Object(i.__extends)(t,e),t.create=function(){return new t((function(){return{}}))},t.withContext=function(e){return new t(e)},t.prototype.invoke=function(e,t,r){var o;if(!this.dirty())return e.call.apply(e,Object(i.__spreadArray)([t],Object(i.__read)(r)));var a=Object.assign(this.createContext(),{args:r,this:t,callee:e,return:void 0,error:void 0});try{this.trigger(n.before,a,this.modifiers.protect),this.modifiers.around.length?this.trigger(n.around,a,this.modifiers.protect):a.return=(o=a.callee).call.apply(o,Object(i.__spreadArray)([a.this],Object(i.__read)(a.args))),this.trigger(n.return,a,this.modifiers.protect)}catch(e){throw this.modifiers.throw.length&&(Object.assign(a,{error:e}),this.trigger(n.throw,a,this.modifiers.protect)),e}finally{this.trigger(n.after,a,this.modifiers.protect)}return a.return},t.prototype.trigger=function(e,t,r){var n,s,c,u;try{for(var l=Object(i.__values)(this.modifiers[e]),h=l.next();!h.done;h=l.next()){var p=h.value;try{p.call(t.this,t)}catch(n){if(!r.length){Object(o.c)(new a(e,n));continue}try{for(var f=(c=void 0,Object(i.__values)(r)),d=f.next();!d.done;d=f.next()){var v=d.value;Object.assign(t,{error:n}),v.call(t.this,t)}}catch(e){c={error:e}}finally{try{d&&!d.done&&(u=f.return)&&u.call(f)}finally{if(c)throw c.error}}}}}catch(e){n={error:e}}finally{try{h&&!h.done&&(s=l.return)&&s.call(l)}finally{if(n)throw n.error}}},t}(u),h=l,p=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Object(i.__extends)(t,e),t.create=function(){return new t((function(){return{}}))},t.withContext=function(e){return new t(e)},t.prototype.invoke=function(e,t,r){var o=this;if(!this.dirty())return e.call.apply(e,Object(i.__spreadArray)([t],Object(i.__read)(r)));var a=Object.assign(this.createContext(),{args:r,this:t,callee:e,return:void 0,error:void 0});return new Promise((function(e,t){Object(i.__awaiter)(o,void 0,void 0,(function(){var e,t,r,o;return Object(i.__generator)(this,(function(s){switch(s.label){case 0:return s.trys.push([0,7,10,12]),[4,this.trigger(n.before,a,this.modifiers.protect)];case 1:return s.sent(),this.modifiers.around.length?[3,3]:(e=(o=a.callee).call.apply(o,Object(i.__spreadArray)([a.this],Object(i.__read)(a.args))),t=a,[4,e]);case 2:return t.return=s.sent(),[3,5];case 3:return[4,this.trigger(n.around,a,this.modifiers.protect)];case 4:s.sent(),s.label=5;case 5:return[4,this.trigger(n.return,a,this.modifiers.protect)];case 6:return s.sent(),[3,12];case 7:return r=s.sent(),Object.assign(a,{error:r}),this.modifiers.throw.length?[4,this.trigger(n.throw,a,this.modifiers.protect)]:[3,9];case 8:s.sent(),s.label=9;case 9:throw r;case 10:return[4,this.trigger(n.after,a,this.modifiers.protect)];case 11:return s.sent(),[7];case 12:return[2]}}))})).then((function(){e(a.return)})).catch((function(e){t(e)}))}))},t.prototype.trigger=function(e,t,r){return Object(i.__awaiter)(this,void 0,void 0,(function(){var n,s,c,u,l,h,p,f,d,v,y,b,g;return Object(i.__generator)(this,(function(_){switch(_.label){case 0:_.trys.push([0,15,16,17]),n=Object(i.__values)(this.modifiers[e]),s=n.next(),_.label=1;case 1:if(s.done)return[3,14];c=s.value,_.label=2;case 2:return _.trys.push([2,4,,13]),[4,c.call(t.this,t)];case 3:return _.sent(),[3,13];case 4:if(u=_.sent(),!r.length)return Object(o.c)(new a(e,u)),[3,13];_.label=5;case 5:_.trys.push([5,10,11,12]),b=void 0,l=Object(i.__values)(r),h=l.next(),_.label=6;case 6:return h.done?[3,9]:(p=h.value,Object.assign(t,{error:u}),[4,p.call(t.this,t)]);case 7:_.sent(),_.label=8;case 8:return h=l.next(),[3,6];case 9:return[3,12];case 10:return f=_.sent(),b={error:f},[3,12];case 11:try{h&&!h.done&&(g=l.return)&&g.call(l)}finally{if(b)throw b.error}return[7];case 12:return[3,13];case 13:return s=n.next(),[3,1];case 14:return[3,17];case 15:return d=_.sent(),v={error:d},[3,17];case 16:try{s&&!s.done&&(y=n.return)&&y.call(n)}finally{if(v)throw v.error}return[7];case 17:return[2]}}))}))},t}(u),f=p},"4e7e6ffadc":function(e,t,r){"use strict";r.r(t),r.d(t,"SchemaActionType",(function(){return o.g})),r.d(t,"DataActionType",(function(){return o.a})),r.d(t,"MIGRATION_ASSIST_TABLE_SCHEMA",(function(){return o.d})),r.d(t,"WhereOperator",(function(){return o.l})),r.d(t,"UNLIMITED",(function(){return o.k})),r.d(t,"QueryExpType",(function(){return o.f})),r.d(t,"QueryAggregateType",(function(){return o.e})),r.d(t,"SortOrder",(function(){return o.i})),r.d(t,"KeyGenerator",(function(){return o.c})),r.d(t,"KeyCompareOp",(function(){return o.b})),r.d(t,"isKey",(function(){return o.o})),r.d(t,"getKeyByPath",(function(){return o.n})),r.d(t,"equalsKeyPaths",(function(){return o.m})),r.d(t,"SchemaDiffUtils",(function(){return o.h})),r.d(t,"TransactionMode",(function(){return o.j})),r.d(t,"primary",(function(){return M})),r.d(t,"index",(function(){return E})),r.d(t,"field",(function(){return C})),r.d(t,"table",(function(){return A})),r.d(t,"StorageEvent",(function(){return D})),r.d(t,"StorageError",(function(){return n})),r.d(t,"Model",(function(){return B}));var n={};r.r(n),r.d(n,"DatabaseConnectError",(function(){return s})),r.d(n,"CollectionNotFoundError",(function(){return c})),r.d(n,"DataMigrationError",(function(){return u})),r.d(n,"IncorrectTransactionModeError",(function(){return l})),r.d(n,"NoTableInfoError",(function(){return h})),r.d(n,"EmptyTableInfoError",(function(){return p})),r.d(n,"InvalidWhereInValueError",(function(){return f})),r.d(n,"UnsupportedWhereOperatorError",(function(){return d})),r.d(n,"OrderByKeyError",(function(){return v})),r.d(n,"DatabaseInternalError",(function(){return y})),r.d(n,"QueryJobError",(function(){return b})),r.d(n,"PluginError",(function(){return g})),r.d(n,"TransactionCommitError",(function(){return _})),r.d(n,"UpdateMigrationChangeInfoError",(function(){return m})),r.d(n,"ExecuteDataUpgradeError",(function(){return w})),r.d(n,"DatabaseUnexpectedClosedError",(function(){return x}));var i=r("d7c625d1f2"),o=r("5d64cf765d"),a=r("7b66f04f1e"),s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Object(i.__extends)(t,e),t.prototype.isQuotaExceeded=function(){return this.message.includes("QuotaExceededError")},t}(a.a.withMessageCreator("DatabaseConnectError",(function(e){return"failed to connect to database '"+e+"'."}))),c=a.a.withMessageCreator("CollectionNotFoundError",(function(e){return"model '"+e+"' is not registered, please register it before use it."})),u=a.a.withMessageCreator("DataMigrationError",(function(e){return"failed to perform data migration, versionChange: "+e.oldVersion+" -> "+e.newVersion+"."})),l=a.a.withMessageCreator("IncorrectTransactionModeError",(function(e){return"use error transaction type["+e+"]."})),h=a.a.withMessageCreator("NoTableInfoError",(function(e){return"'"+e+"' is not a valid model with table info injected, please ensure the model class is decorated by @table(), @field() etc."})),p=a.a.withDefaultMessage("EmptyTableInfoError","table without any field declare, please define model use [field] decorator."),f=a.a.withMessageCreator("InvalidWhereInValueError",(function(e){return"there is an error in your where clause of field '"+e.path+"'."+e.op+", the value must be an array."})),d=a.a.withMessageCreator("UnsupportedWhereOperatorError",(function(e){return"unsupported where operator '"+e+"', current supported operators are >, >=, <, <=, =, !=, in, nin."})),v=a.a.withDefaultMessage("OrderByKeyError","can not order value that is not Key: 'Key = number | string | Date | BufferSource | Key[]'."),y=a.a.withMessageCreator("DatabaseInternalError",(function(e){return"there is an internal error of database, reason: "+e+"."})),b=a.a.withMessageCreator("QueryJobError",(function(e){return"failed to execute query job, reason: "+e+"."})),g=a.a.withMessageCreator("PluginError",(function(e){return'an error has occurred on plugin "'+e.name+'"": '+e.message+"."})),_=a.a.withDefaultMessage("TransactionCommitError","failed to commit transaction."),m=a.a.withDefaultMessage("UpdateMigrationChangeInfoError","failed to update migration change info"),w=a.a.withMessageCreator("ExecuteDataUpgradeError",(function(e){return"failed to execute data upgrade on collection '"+e+"'."})),x=a.a.withMessageCreator("UnexpectedClosedError",(function(e){return"database "+e+" is unexpectedly closed by browser, this could happen when disk is unavailable or the page is shutdown."})),O=Symbol.for("TABLE_KEY"),j=function(){function e(){}return e.saveTableInfo=function(e,t){Object.defineProperty(t,O,{configurable:!0,value:Object(i.__assign)({},e)})},e.getTableInfo=function(e){return e[O]},e.getFirstTableInfoAlongPrototypeChain=function(e){var t=this.getTableInfo(e),r=Object.assign({},t);return r.properties=new Map(r.properties),r},e.getTableName=function(e){var t=this.getTableInfo(e.prototype);if(!(null==t?void 0:t.tableName))throw new h(e.name);return t.tableName},e.addTablePropertyInfo=function(t,r){var n=e.getOrCreateTableInfo(t);if(n.properties.has(r.name)){var i=n.properties.get(r.name);Object.assign(r,i)}n.properties.set(r.name,r),this.saveTableInfo(n,t)},e.createPropertyInfo=function(e,t){return{name:e,alias:t,isUnionKey:!1}},e.convertTableInfoToSchema=function(e){if(!e.tableName)return null;var t,r=Object(i.__spreadArray)([],Object(i.__read)(e.properties.values())),n=r.filter((function(e){return e.isIndex})).map((function(e){var t,r;return{name:null!==(t=e.alias)&&void 0!==t?t:e.name,path:null!==(r=e.alias)&&void 0!==r?r:e.name,unique:e.isUnique}}));return t=!e.autoIncrement&&e.keyPath?{path:1===e.keyPath.length?e.keyPath[0]:e.keyPath}:{generator:o.c.AutoIncrement},{properties:r.map((function(e){var t;return null!==(t=e.alias)&&void 0!==t?t:e.name})),indices:n,key:t,name:e.tableName}},e.createDefaultTableInfo=function(){return{tableName:null,autoIncrement:!0,properties:new Map}},e.getOrCreateTableInfo=function(t){if(Object.prototype.hasOwnProperty.call(t,O))return t[O];var r=e.createDefaultTableInfo(),n=t[O];return n&&(r.properties=new Map(Object(i.__spreadArray)(Object(i.__spreadArray)([],Object(i.__read)(n.properties)),Object(i.__read)(r.properties)))),e.saveTableInfo(r,t),r},e}();var C=function(e){return function(t,r){var n=j.createPropertyInfo(r,e);j.addTablePropertyInfo(t,n)}};var A=function(e,t){return function(r){var n=j.getFirstTableInfoAlongPrototypeChain(r.prototype);if(!n)throw new p;n.tableName=e;var o=Object(i.__spreadArray)([],Object(i.__read)(n.properties.values())),a=function(e,t){if(null==e?void 0:e.key)return"string"==typeof e.key?[e.key]:e.key;var r=t.filter((function(e){return e.isPrimaryKey})).map((function(e){var t;return null!==(t=e.alias)&&void 0!==t?t:e.name}));return r.length>0?r:void 0}(t,o);n.keyPath=a,n.autoIncrement=void 0===n.keyPath,j.saveTableInfo(n,r.prototype)}};var E=function(e){return function(t,r){var n=j.createPropertyInfo(r);n.isIndex=!0,n.isUnique=!!(null==e?void 0:e.unique),j.addTablePropertyInfo(t,n)}};var M=function(){return function(e,t){var r=j.createPropertyInfo(t);r.isPrimaryKey=!0,j.addTablePropertyInfo(e,r)}};let S=()=>({events:{},emit(e,...t){(this.events[e]||[]).forEach((e=>e(...t)))},on(e,t){return(this.events[e]=this.events[e]||[]).push(t),()=>this.events[e]=(this.events[e]||[]).filter((e=>e!==t))}});var D,I;!function(e){e.Ready="Ready",e.Fetal="Fetal",e.Closed="Closed",e.Destroyed="Destroyed",e.Error="Error",e.RegisterModel="RegisterModel",e.RegisterPlugin="RegisterPlugin",e.BootstrapStart="BootstrapStart",e.BootstrapEnd="BootstrapEnd",e.SchemaMigrationStart="SchemaMigrationStart",e.SchemaMigrationEnd="SchemaMigrationEnd",e.VersionChange="VersionChange"}(D||(D={})),function(e){e.CollectionCreated="CollectionCreated",e.ModelLazyMigrationEnd="ModelLazyMigrationEnd",e.PrepareAutoUpgradeEnd="PrepareAutoUpgradeEnd",e.UpdateMigrationChangeInfo="UpdateMigrationChangeInfoEnd",e.StartTransaction="StartTransaction"}(I||(I={}));var N,T=function(){function e(e){var t=this;this.onClosed=function(e){t.eventBus.on(D.Closed,e)},this.eventBus=e}return e.prototype.onReady=function(e){this.eventBus.on(D.Ready,e)},e.prototype.onFetal=function(e){this.eventBus.on(D.Fetal,e)},e.prototype.onError=function(e){this.eventBus.on(D.Error,e)},e.prototype.onRegisterModel=function(e){this.eventBus.on(D.RegisterModel,e)},e.prototype.onRegisterPlugin=function(e){this.eventBus.on(D.RegisterPlugin,e)},e.prototype.onBootstrapStart=function(e){this.eventBus.on(D.BootstrapStart,e)},e.prototype.onBootstrapEnd=function(e){this.eventBus.on(D.BootstrapEnd,e)},e.prototype.onSchemaMigrationStart=function(e){this.eventBus.on(D.SchemaMigrationStart,e)},e.prototype.onSchemaMigrationEnd=function(e){this.eventBus.on(D.SchemaMigrationEnd,e)},e.prototype.onVersionChange=function(e){this.eventBus.on(D.VersionChange,e)},e.prototype.emitError=function(e){this.eventBus.emit(D.Error,e)},e}(),B=function(){function e(){}return e.revealSchema=function(e){var t=j.getTableInfo(e.prototype);return t?j.convertTableInfoToSchema(t):null},e}(),R=function(){function e(e){this.models=[],this.eventBus=e}return e.prototype.register=function(e){if(!this.models.includes(e)){var t=this.getSchema(e);this.models.push(e),this.eventBus.emit(D.RegisterModel,{class:e,schema:t})}},e.prototype.getSchema=function(e){var t=B.revealSchema(e);if(!t){var r=new h(e.name);throw this.eventBus.emit(D.Error,r),new h(e.name)}return t},e.prototype.getSchemaAndRegisterModelIfNeed=function(e){return this.register(e),this.getSchema(e)},e}();function k(e){var t,r,n,o=j.getTableInfo(Object.getPrototypeOf(e));if(!o)return e;var a={};try{for(var s=Object(i.__values)(o.properties.values()),c=s.next();!c.done;c=s.next()){var u=c.value;a[null!==(n=u.alias)&&void 0!==n?n:u.name]=e[u.name]}}catch(e){t={error:e}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return a}function P(e,t){var r,n;if(null==e)return null;var o=j.getTableInfo(t.prototype);if(!o)return e;var a=function(e,t){var r,n,o,a={};try{for(var s=Object(i.__values)(t.properties.values()),c=s.next();!c.done;c=s.next()){var u=c.value,l=null!==(o=u.alias)&&void 0!==o?o:u.name;a[u.name]=e[l]}}catch(e){r={error:e}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return a}(e,o),s=new t(a);try{for(var c=Object(i.__values)(Object.keys(a)),u=c.next();!u.done;u=c.next()){var l=u.value;void 0!==a[l]&&(s[l]=a[l])}}catch(e){r={error:e}}finally{try{u&&!u.done&&(n=c.return)&&n.call(c)}finally{if(r)throw r.error}}return s}!function(e){e.FILL="fill",e.HYDRATE="hydrate",e.PAGINATE="paginate",e.FILTER="filter",e.SORT="sort",e.SCAN="scan",e.SCAN_ALL="scan-all",e.INDEX_SCAN="index-scan",e.UNION="union",e.DISTINCT="distinct",e.INTERSECT="intersect"}(N||(N={}));var L=function(){function e(e,t){this.node=e,this.parent=t,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,o,a;return Object(i.__generator)(this,(function(s){try{for(t=Object(i.__values)(this.node.inputs),r=t.next();!r.done;r=t.next())n=r.value,e.push(n)}catch(e){o={error:e}}finally{try{r&&!r.done&&(a=t.return)&&a.call(t)}finally{if(o)throw o.error}}return[2]}))}))},e}(),F=function(){function e(e){this.comparer=e}return e.prototype.has=function(e,t){return-1!==this.getOrder(e,t)},e.prototype.getOrder=function(e,t){for(var r=0,n=e.length;r<n;){var i=r+Math.floor((n-r)/2),o=e[i],a=this.comparer.cmp(t,o);if(0===a)return i;a>0?r=i+1:n=i}return-1},e}(),q=function(){function e(e,t){this.node=e,this.parent=t,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,o,a,s,c,u,l,h,p,f,d,v,y,b,g;return Object(i.__generator)(this,(function(_){t=new F(this.node.comparer);try{for(r=Object(i.__values)(this.context.inputs),n=r.next();!n.done;n=r.next()){o=n.value,a=new Map,s=o.map((function(e){return Object(i.__read)(e,1)[0]})).sort(this.node.comparer.cmp),c=[];try{for(b=void 0,u=Object(i.__values)(o),l=u.next();!l.done;l=u.next())h=l.value,p=Object(i.__read)(h,1),f=p[0],d=t.getOrder(s,f),a.has(d)||(a.set(d,!0),c.push(h))}catch(e){b={error:e}}finally{try{l&&!l.done&&(g=u.return)&&g.call(u)}finally{if(b)throw b.error}}e.push(c)}}catch(e){v={error:e}}finally{try{n&&!n.done&&(y=r.return)&&y.call(r)}finally{if(v)throw v.error}}return[2]}))}))},e}(),V=Symbol("-∞"),G=Symbol("+∞"),U=function(){function e(e){var t=this;this.contains=function(e,r){var n=t,i=n.cmp,o=n.lowerOf,a=n.upperOf;if(!t.isValid(e))return!1;var s=e.lowerOpen,c=e.upperOpen,u=i(o(e),r),l=i(a(e),r);return 0===u&&!s||u<0&&l>0||0===l&&!c},this.union=function(e){if(e.length<=1)return e;t.sort(e);for(var r=[],n=e[0],i=1;i<e.length;i++){var o=e[i];t.isOverlapped(n,o)?n=t.wrap(n,o):(r.push(n),n=o)}return r.push(n),r},this.intersect=function(e){var r,n;if(e.length<=1)return e;t.sort(e);var o=e[0];try{for(var a=Object(i.__values)(e),s=a.next();!s.done;s=a.next()){var c=s.value;if(!t.isOverlapped(o,c))return[];o=t.overlap(o,c)}}catch(e){r={error:e}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return[o]},this.isValid=function(e){var r=t,n=r.cmp,i=r.lowerOf,o=r.upperOf,a=n(i(e),o(e));return a<0||0===a&&!e.lowerOpen&&!e.upperOpen},this.cmp=function(e,r){return e!==V&&e!==G&&r!==V&&r!==G?t.comparer.cmp(e,r):e===r?0:e===V||r===G?-1:1},this.lowerOf=function(e){return void 0===e.lower?V:e.lower},this.upperOf=function(e){return void 0===e.upper?G:e.upper},this.comparer=e}return e.prototype.isOverlapped=function(e,t){var r,n=this,o=n.cmp,a=n.lowerOf,s=n.upperOf,c=Object(i.__read)([e,t],2),u=c[0],l=c[1],h=o(a(u),a(l));(h>0||0===h&&!u.lowerOpen&&l.lowerOpen)&&(u=(r=Object(i.__read)([l,u],2))[0],l=r[1]);var p=o(s(u),a(l));return p>0||0===p&&!u.upperOpen&&!l.lowerOpen},e.prototype.sort=function(e){var t=this.cmp,r=this.lowerOf;return e.sort((function(e,n){var i=t(r(e),r(n));return 0!==i||e.lowerOpen===n.lowerOpen?i:e.lowerOpen?-1:1}))},e.prototype.wrap=function(e,t){var r=this,n=r.cmp,o=r.lowerOf,a=r.upperOf,s=Object(i.__assign)({},e),c=n(o(e),o(t)),u=n(a(e),a(t));return(c>0||0===c&&!t.lowerOpen)&&(s.lower=t.lower,s.lowerOpen=t.lowerOpen),(u<0||0===u&&!t.upperOpen)&&(s.upper=t.upper,s.upperOpen=t.upperOpen),s},e.prototype.overlap=function(e,t){var r=this,n=r.cmp,o=r.lowerOf,a=r.upperOf,s=Object(i.__assign)({},e),c=n(o(e),o(t)),u=n(a(e),a(t));return(c<0||0===c&&!e.lowerOpen)&&(s.lower=t.lower,s.lowerOpen=t.lowerOpen),(u>0||0===u&&!e.upperOpen)&&(s.upper=t.upper,s.upperOpen=t.upperOpen),s},e}(),K=function(){function e(e,t){this.node=e,this.parent=t,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,o,a,s,c,u,l;return Object(i.__generator)(this,(function(h){for(t=[],r=this.node,n=[t];r;)r.regroup&&(t=[],n.push(t)),t.push(this.createFilter(r)),r=r.nextFilter;o=function(e){var t=Object(i.__read)(e,2)[1];return n.some((function(e){return e.every((function(e){return e(t)}))}))};try{for(a=Object(i.__values)(this.context.inputs),s=a.next();!s.done;s=a.next())c=s.value,e.push(c.filter(o))}catch(e){u={error:e}}finally{try{s&&!s.done&&(l=a.return)&&l.call(a)}finally{if(u)throw u.error}}return[2]}))}))},e.prototype.createFilter=function(e){var t=new U(e.comparer);return function(r){return e.intervals.some((function(n){if(void 0===r)throw new y("can not do filter on non-hydrated data");var i=Object(o.n)(r,e.path);return Object(o.o)(i)&&t.contains(n,i)}))}},e}();var W=function(){function e(e,t,r){this.node=e,this.parent=t,this.transaction=r,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,o,a,s,c,u,l=this;return Object(i.__generator)(this,(function(h){switch(h.label){case 0:t=this.transaction.table(this.node.collectionSchema.name),r=function(r){var n;return Object(i.__generator)(this,(function(o){switch(o.label){case 0:return n=r.filter((function(e){return!function(e){return!!Object(i.__read)(e,2)[1]}(e)})),[4,Promise.all(n.map((function(e,r){var o=Object(i.__read)(e,1)[0];return Object(i.__awaiter)(l,void 0,void 0,(function(){var e;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return[4,t.get(o)];case 1:return e=i.sent(),n[r][1]=e,[2]}}))}))})))];case 1:return o.sent(),e.push(r),[2]}}))},h.label=1;case 1:h.trys.push([1,6,7,8]),n=Object(i.__values)(this.context.inputs),o=n.next(),h.label=2;case 2:return o.done?[3,5]:(a=o.value,[5,r(a)]);case 3:h.sent(),h.label=4;case 4:return o=n.next(),[3,2];case 5:return[3,8];case 6:return s=h.sent(),c={error:s},[3,8];case 7:try{o&&!o.done&&(u=n.return)&&u.call(n)}finally{if(c)throw c.error}return[7];case 8:return[2]}}))}))},e}(),H=function(){function e(e,t,r,n){this.lower=e,this.upper=t,this.lowerOpen=r,this.upperOpen=n}return e.getKeyRange=function(e,t){if(void 0!==t){if(!e.isValid(t))throw new Error("invalid key interval");var r=t.lower,n=t.upper,i=t.lowerOpen,o=t.upperOpen;return r===n?r:void 0!==r&&void 0!==n?IDBKeyRange.bound(r,n,i,o):void 0!==r?IDBKeyRange.lowerBound(r,i):IDBKeyRange.upperBound(n,o)}},e}(),z=function(){function e(e,t){var r=this;this.comparer=t,this.math=new U(t),this.intervals=e.filter((function(e){return r.math.isValid(e)}))}return e.fromWherePredicate=function(t,r){var n,o,a;try{for(var s=Object(i.__values)(Object.keys(t)),c=s.next();!c.done;c=s.next()){var u=c.value,l=t[u];if(void 0!==l){var h=e.fromWhereExp(u,l,r);a=a?a.intersect(h):h}}}catch(e){n={error:e}}finally{try{c&&!c.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}return a||this.createFullGroup(r)},e.fromWhereExp=function(t,r,n){var i;if(t===o.l.In||t===o.l.NotIn){if(!Array.isArray(r))throw new f({op:t});var a=r;return t===o.l.In?a.reduce((function(t,r){return t.union(e.fromWhereExp(o.l.Equals,r,n))}),this.createEmptyGroup(n)):a.reduce((function(t,r,i){var a=e.fromWhereExp(o.l.NotEquals,r,n);return i?t.intersect(a):a}),this.createFullGroup(n))}switch(t){case o.l.Equals:i=[new H(r,r,!1,!1)];break;case o.l.NotEquals:i=[new H(void 0,r,!0,!0),new H(r,void 0,!0,!0)];break;case o.l.GreaterThan:i=[new H(r,void 0,!0,!0)];break;case o.l.GreaterOrEqualThan:i=[new H(r,void 0,!1,!0)];break;case o.l.LessThan:i=[new H(void 0,r,!0,!0)];break;case o.l.LessOrEqualThan:i=[new H(void 0,r,!0,!1)];break;default:throw new d(t)}return new e(i,n)},e.prototype.union=function(t){return new e(this.math.union(Object(i.__spreadArray)(Object(i.__spreadArray)([],Object(i.__read)(this.intervals)),Object(i.__read)(t.intervals))),this.comparer)},e.prototype.intersect=function(t){for(var r=this.math,n=r.cmp,o=r.upperOf,a=r.lowerOf,s=r.intersect,c=Object(i.__read)([this.intervals,t.intervals],2),u=c[0],l=c[1],h=Object(i.__read)([0,0],2),p=h[0],f=h[1],d=[];p<u.length;){for(;f<l.length&&n(o(u[p]),a(l[f]))>=0;){var v=s([u[p],l[f]]);d.push.apply(d,Object(i.__spreadArray)([],Object(i.__read)(v))),f+=1}f-=1,p+=1}return new e(d,this.comparer)},e.prototype.contains=function(e){var t=this;return!!this.intervals.find((function(r){return t.math.contains(r,e)}))},e.prototype.isEmpty=function(){return 0===this.intervals.length},e.prototype.isFull=function(){return!!this.intervals.length&&void 0===this.intervals[0].lower&&void 0===this.intervals[0].upper},e.createFullGroup=function(t){return new e([new H(void 0,void 0,!0,!0)],t)},e.createEmptyGroup=function(t){return new e([],t)},e}(),Q=H,Y=function(){function e(e,t,r){this.node=e,this.parent=t,this.transaction=r,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,a,s;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return this.node.hydrate?[3,2]:[4,this.scanKeys()];case 1:return t=i.sent(),e.push(t.map((function(e){return[e,void 0]}))),[2];case 2:return(r=this.node.collectionSchema.key.path)?[4,this.scanValues()]:[3,4];case 3:return n=i.sent(),e.push(n.map((function(e){return[Object(o.n)(e,r),e]}))),[2];case 4:return[4,this.scanKeys()];case 5:return a=i.sent(),[4,this.scanValues()];case 6:return s=i.sent(),e.push(a.map((function(e,t){return[e,s[t]]}))),[2]}}))}))},e.prototype.scanKeys=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t;return Object(i.__generator)(this,(function(r){switch(r.label){case 0:return e=this.getKeyQueries(),t=this.getIndex(),[4,Promise.all(e.map((function(e){return t.getAllKeys(e)})))];case 1:return[2,r.sent().reduce((function(e,t){return e.push.apply(e,Object(i.__spreadArray)([],Object(i.__read)(t))),e}),[])]}}))}))},e.prototype.scanValues=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t;return Object(i.__generator)(this,(function(r){switch(r.label){case 0:return e=this.getKeyQueries(),t=this.getIndex(),[4,Promise.all(e.map((function(e){return t.getAll(e)})))];case 1:return[2,r.sent().reduce((function(e,t){return e.push.apply(e,Object(i.__spreadArray)([],Object(i.__read)(t))),e}),[])]}}))}))},e.prototype.getKeyQueries=function(){var e=new U(this.node.comparer);return this.node.intervals.map((function(t){return Q.getKeyRange(e,t)}))},e.prototype.getIndex=function(){var e=this.node,t=e.collectionSchema,r=e.index;return this.transaction.table(t.name).index(r.name)},e}(),J=function(){function e(e,t){this.node=e,this.parent=t,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,o,a,s,c,u,l,h,p,f,d;return Object(i.__generator)(this,(function(v){if(r=(t=this).context,n=t.node,!(o=r.inputs).length)return[2];if(1===o.length)return e.push(o[0]),[2];a=function(e,t){var r=Object(i.__read)(e,1)[0],o=Object(i.__read)(t,1)[0];return n.comparer.cmp(r,o)},s=new F({cmp:a}),c=this.getSmallestPointers(o).slice();try{for(u=Object(i.__values)(o),l=u.next();!l.done;l=u.next())l.value.sort(a)}catch(e){f={error:e}}finally{try{l&&!l.done&&(d=u.return)&&d.call(u)}finally{if(f)throw f.error}}return h=function(e){return o.every((function(t){return s.has(t,e)}))},p=c.filter(h),e.push(p),[2]}))}))},e.prototype.getSmallestPointers=function(e){return e.reduce((function(e,t){return e.length<t.length?e:t}),this.context.inputs[0])},e}(),X=function(){function e(e,t){this.node=e,this.parent=t,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,o,a,s,c,u;return Object(i.__generator)(this,(function(l){t=this.node,r=t.offset,n=t.limit;try{for(o=Object(i.__values)(this.context.inputs),a=o.next();!a.done;a=o.next())s=a.value,e.push(s.slice(r,!n||isNaN(n)?void 0:r+n))}catch(e){c={error:e}}finally{try{a&&!a.done&&(u=o.return)&&u.call(o)}finally{if(c)throw c.error}}return[2]}))}))},e}(),Z=function(){function e(e,t,r){this.node=e,this.parent=t,this.transaction=r,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,a,s;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return this.node.hydrate?[3,2]:[4,this.scanKeys()];case 1:return t=i.sent(),e.push(t.map((function(e){return[e,void 0]}))),[2];case 2:return(r=this.node.collectionSchema.key.path)?[4,this.scanValues()]:[3,4];case 3:return n=i.sent(),e.push(n.map((function(e){return[Object(o.n)(e,r),e]}))),[2];case 4:return[4,this.scanKeys()];case 5:return a=i.sent(),[4,this.scanValues()];case 6:return s=i.sent(),e.push(a.map((function(e,t){return[e,s[t]]}))),[2]}}))}))},e.prototype.scanKeys=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t;return Object(i.__generator)(this,(function(r){switch(r.label){case 0:return e=this.getKeyQueries(),t=this.getTable(),[4,Promise.all(e.map((function(e){return t.getAllKeys(e)})))];case 1:return[2,r.sent().reduce((function(e,t){return e.push.apply(e,Object(i.__spreadArray)([],Object(i.__read)(t))),e}),[])]}}))}))},e.prototype.scanValues=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t;return Object(i.__generator)(this,(function(r){switch(r.label){case 0:return e=this.getKeyQueries(),t=this.getTable(),[4,Promise.all(e.map((function(e){return t.getAll(e)})))];case 1:return[2,r.sent().reduce((function(e,t){return e.push.apply(e,Object(i.__spreadArray)([],Object(i.__read)(t))),e}),[])]}}))}))},e.prototype.getKeyQueries=function(){var e=new U(this.node.comparer);return this.node.type===N.SCAN_ALL?[void 0]:this.node.intervals.map((function(t){return Q.getKeyRange(e,t)}))},e.prototype.getTable=function(){var e=this.node.collectionSchema;return this.transaction.table(e.name)},e}(),$=function(){function e(e,t){this.node=e,this.parent=t,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n,a,s,c,u,l,h,p=this;return Object(i.__generator)(this,(function(f){t=this.node,r=t.comparer,n=t.path,a=t.order;try{for(s=Object(i.__values)(this.context.inputs),c=s.next();!c.done;c=s.next())(u=c.value).sort((function(e,t){var s=Object(i.__read)(e,2)[1],c=Object(i.__read)(t,2)[1],u=Object(o.n)(s,n),l=Object(o.n)(c,n),h=p.getComparerByType(r,a);if(Object(o.o)(u)&&Object(o.o)(l))return h(u,l);throw new v})),e.push(u)}catch(e){l={error:e}}finally{try{c&&!c.done&&(h=s.return)&&h.call(s)}finally{if(l)throw l.error}}return[2]}))}))},e.prototype.getComparerByType=function(e,t){return t===o.i.ASCENDING?function(t,r){return e.cmp(t,r)}:function(t,r){return-e.cmp(t,r)}},e}(),ee=function(){function e(e,t){this.node=e,this.parent=t,this.context=te(e)}return e.prototype.perform=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){return Object(i.__generator)(this,(function(t){return e.push(this.context.inputs.reduce((function(e,t){return e.push.apply(e,Object(i.__spreadArray)([],Object(i.__read)(t))),e}),[])),[2]}))}))},e}();function te(e){return{total:e.children.length,done:0,inputs:[]}}var re=function(){function e(e,t){this.onRequestSuccess=function(){},this.onRequestFailed=function(){},this.request=e,this.transaction=t,this.jobs=new Map}return e.prototype.exec=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e=this;return Object(i.__generator)(this,(function(t){return this.task||(this.task=new Promise((function(t,r){e.onRequestSuccess=function(r){e.reset(),t(r)},e.onRequestFailed=function(t){return Object(i.__awaiter)(e,void 0,void 0,(function(){return Object(i.__generator)(this,(function(e){return this.reset(),r(t),[2]}))}))},e.traverse(e.request.root,(function(t,r){var n=function(e,t,r){var n;return(n={},n[N.FILL]=function(){return new L(e,t)},n[N.DISTINCT]=function(){return new q(e,t)},n[N.FILTER]=function(){return new K(e,t)},n[N.HYDRATE]=function(){return new W(e,t,r)},n[N.INDEX_SCAN]=function(){return new Y(e,t,r)},n[N.INTERSECT]=function(){return new J(e,t)},n[N.PAGINATE]=function(){return new X(e,t)},n[N.SCAN]=function(){return new Z(e,t,r)},n[N.SCAN_ALL]=function(){return new Z(e,t,r)},n[N.SORT]=function(){return new $(e,t)},n[N.UNION]=function(){return new ee(e,t)},n)[e.type]()}(t,r&&e.jobs.get(r)||null,e.transaction);e.jobs.set(t,n),t.children.length||e.beginJob(n).catch((function(t){e.onRequestFailed(t)}))}))}))),[2,this.task]}))}))},e.prototype.beginJob=function(e){var t;return Object(i.__awaiter)(this,void 0,void 0,(function(){var r,n,o=this;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:r=(null===(t=e.parent)||void 0===t?void 0:t.context.inputs)||[],i.label=1;case 1:return i.trys.push([1,3,,4]),[4,e.perform(r)];case 2:return i.sent(),this.finishJob(e,r).catch((function(e){o.onRequestFailed(e)})),[3,4];case 3:return n=i.sent(),this.onRequestFailed(n),[3,4];case 4:return[2]}}))}))},e.prototype.finishJob=function(e,t){return Object(i.__awaiter)(this,void 0,void 0,(function(){var r,n=this;return Object(i.__generator)(this,(function(i){return e.parent&&((r=e.parent.context).done+=1,r.done===r.total&&this.beginJob(e.parent).catch((function(e){n.onRequestFailed(e)}))),e.node===this.request.root&&this.onRequestSuccess(t),[2]}))}))},e.prototype.reset=function(){this.jobs=new Map,this.task=void 0,this.onRequestSuccess=function(){},this.onRequestFailed=function(){}},e.prototype.traverse=function(e,t,r){var n,o;t(e,r);try{for(var a=Object(i.__values)(e.children),s=a.next();!s.done;s=a.next()){var c=s.value;this.traverse(c,t,e)}}catch(e){n={error:e}}finally{try{s&&!s.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}},e}(),ne=function(){function e(e){this.comparer=e}return e.prototype.rewrite=function(e){return{offset:e.offset,limit:e.limit,order:e.order&&Object(i.__assign)({},e.order),exp:this.rewriteWhereClauses(e.whereClauses)}},e.prototype.rewriteWhereClauses=function(e){var t,r,n,a,s;if(!e.length)return{type:o.f.ALL};var c={type:o.f.OR,exps:[]};try{for(var u=Object(i.__values)(e),l=u.next();!l.done;l=u.next()){var h=l.value,p={type:o.f.AND,exps:[]};try{for(var f=(n=void 0,Object(i.__values)(Object.entries(h))),d=f.next();!d.done;d=f.next()){var v=Object(i.__read)(d.value,2),y=v[0],b=v[1];if(void 0!==b){var g=Object(o.o)(b)?((s={})[o.l.Equals]=b,s):b;this.isEmptyPredicate(g)||p.exps.push({type:o.f.FILTER,predicate:g,path:y,hints:{intervalGroup:z.fromWherePredicate(g,this.comparer),isKey:!1,indices:[]}})}}}catch(e){n={error:e}}finally{try{d&&!d.done&&(a=f.return)&&a.call(f)}finally{if(n)throw n.error}}c.exps.push(p)}}catch(e){t={error:e}}finally{try{l&&!l.done&&(r=u.return)&&r.call(u)}finally{if(t)throw t.error}}return c},e.prototype.isEmptyPredicate=function(e){return Object.values(e).every((function(e){return void 0===e}))},e}(),ie=function(){function e(e){this.schema=e,this.indicesMap=new Map,this.warmupIndicesMap()}return e.prototype.bind=function(e){return this.bindQueryHints(e.exp),e},e.prototype.bindQueryHints=function(e){var t,r=this,n=e;n.type!==o.f.AND&&n.type!==o.f.OR?n.type===o.f.FILTER&&(n.hints.isKey=this.schema.key&&Object(o.m)(this.schema.key.path,n.path),n.hints.indices=null!==(t=this.indicesMap.get(n.path))&&void 0!==t?t:[]):n.exps.forEach((function(e){return r.bindQueryHints(e)}))},e.prototype.warmupIndicesMap=function(){var e,t,r,n,o;try{for(var a=Object(i.__values)(this.schema.indices.entries()),s=a.next();!s.done;s=a.next()){var c=Object(i.__read)(s.value,2),u=c[0],l=c[1];l.priority=null!==(o=l.priority)&&void 0!==o?o:-(u+1);var h=Array.isArray(l.path)?l.path:[l.path];try{for(var p=(r=void 0,Object(i.__values)(h)),f=p.next();!f.done;f=p.next()){var d=f.value,v=this.indicesMap.get(d)||[];v.push(l),this.indicesMap.set(d,v)}}catch(e){r={error:e}}finally{try{f&&!f.done&&(n=p.return)&&n.call(p)}finally{if(r)throw r.error}}}}catch(t){e={error:t}}finally{try{s&&!s.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}},e}(),oe=function(){function e(e,t){this.collectionSchema=e,this.comparer=t}return e.prototype.plan=function(e,t){return{root:this.getRootNode(e,t),aggregate:t}},e.prototype.getRootNode=function(e,t){if(e.exp.type===o.f.NONE)return this.getSkipNode();var r=this.getBaseNode(e.exp);return(t===o.e.ENTRIES||t===o.e.VALUES||e.order)&&(r=this.getHydrateNode([r])),e.order&&(r=this.getSortNode(e.order.path,e.order.type,[r])),(e.offset||e.limit!==o.k)&&(r=this.getPaginateNode(e.offset,e.limit,[r])),r=this.getDistinctNode([r])},e.prototype.getBaseNode=function(e){return e.type===o.f.ALL?this.getScanAllNode():e.type===o.f.NONE?this.getSkipNode():e.type===o.f.FILTER?this.getFilterNode(e):this.getLogicExpNode(e)},e.prototype.getLogicExpNode=function(e){var t,r,n=[];try{for(var a=Object(i.__values)(e.exps),s=a.next();!s.done;s=a.next()){var c=s.value;n.push(c.type===o.f.FILTER?this.getFilterNode(c):this.getLogicExpNode(c))}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return e.type===o.f.AND?this.getIntersectNode(n):this.getUnionNode(n)},e.prototype.getFilterNode=function(e){if(!e.path||e.hints.isKey)return this.getScanNode(e.hints.intervalGroup.intervals);var t=e.hints.indices.find((function(t){return Object(o.m)(t.path,e.path)}));return t?this.getIndexScanNode(e.hints.intervalGroup.intervals,t):this.getMemFilterNode(e.hints.intervalGroup.intervals,e.path)},e.prototype.getIntersectNode=function(e){return{type:N.INTERSECT,comparer:this.comparer,children:e}},e.prototype.getDistinctNode=function(e){return void 0===e&&(e=[]),{type:N.DISTINCT,comparer:this.comparer,children:e}},e.prototype.getUnionNode=function(e){return void 0===e&&(e=[]),{type:N.UNION,children:e}},e.prototype.getHydrateNode=function(e){return void 0===e&&(e=[]),{type:N.HYDRATE,collectionSchema:this.collectionSchema,children:e}},e.prototype.getPaginateNode=function(e,t,r){return void 0===r&&(r=[]),{type:N.PAGINATE,offset:e,limit:t,children:r}},e.prototype.getSortNode=function(e,t,r){return void 0===r&&(r=[]),{type:N.SORT,path:e,order:t,comparer:this.comparer,children:r}},e.prototype.getMemFilterNode=function(e,t,r){return{type:N.FILTER,comparer:this.comparer,path:t,intervals:e,regroup:!1,children:[{type:N.HYDRATE,collectionSchema:this.collectionSchema,children:r||[this.getScanAllNode()]}]}},e.prototype.getIndexScanNode=function(e,t){return{type:N.INDEX_SCAN,collectionSchema:this.collectionSchema,index:t,intervals:e,comparer:this.comparer,children:[]}},e.prototype.getScanNode=function(e){return{type:N.SCAN,collectionSchema:this.collectionSchema,intervals:e,comparer:this.comparer,children:[]}},e.prototype.getScanAllNode=function(){return{type:N.SCAN_ALL,collectionSchema:this.collectionSchema,comparer:this.comparer,children:[]}},e.prototype.getSkipNode=function(){return{type:N.FILL,inputs:[[]],children:[]}},e}(),ae=function(){function e(){}return e.prototype.eliminate=function(e){var t=e;return t.exp=this.eliminateExp(e.exp),t},e.prototype.eliminateExp=function(e){return e.type===o.f.AND?this.eliminateAndExp(e):e.type===o.f.OR?this.eliminateOrExp(e):e.type===o.f.FILTER?this.eliminateFilterExp(e):e},e.prototype.eliminateAndExp=function(e){var t,r,n={type:o.f.AND,exps:[]};try{for(var a=Object(i.__values)(e.exps),s=a.next();!s.done;s=a.next()){var c=s.value,u=this.eliminateExp(c);if(u.type===o.f.NONE)return{type:o.f.NONE};u.type!==o.f.ALL&&n.exps.push(u)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return n.exps.length?1===n.exps.length?n.exps[0]:n:{type:o.f.ALL}},e.prototype.eliminateOrExp=function(e){var t,r,n={type:o.f.OR,exps:[]};try{for(var a=Object(i.__values)(e.exps),s=a.next();!s.done;s=a.next()){var c=s.value,u=this.eliminateExp(c);if(u.type===o.f.ALL)return{type:o.f.ALL};u.type!==o.f.NONE&&n.exps.push(u)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return n.exps.length?1===n.exps.length?e.exps[0]:n:{type:o.f.NONE}},e.prototype.eliminateFilterExp=function(e){return e.hints.intervalGroup.isEmpty()?{type:o.f.NONE}:e.hints.intervalGroup.isFull()?{type:o.f.ALL}:e},e}();var se=function(){var e,t=!1;return function(r,n){if("function"!=typeof r[n])throw new Error("memo() must be decorated on one of function properties of target");Object.defineProperty(r,n,Object(i.__assign)(Object(i.__assign)({},Object.getOwnPropertyDescriptor(r,n)),{value:function(){return t||(e=r[n](),t=!0),e}}))}},ce=N.UNION,ue=N.INTERSECT,le=N.HYDRATE,he=N.INDEX_SCAN,pe=N.SCAN,fe=N.SCAN_ALL,de=N.FILTER;function ve(e){return ye(e.root),e}function ye(e){var t,r,n=e.children;try{for(var o=Object(i.__values)(n.entries()),a=o.next();!a.done;a=o.next()){var s=Object(i.__read)(a.value,2),c=s[0],u=s[1];if(ye(u),[ue,ce].includes(u.type)&&1===u.children.length){var l=u.children[0];n[c]=l}}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}}function be(e){return ge(e.root),e}function ge(e){var t,r,n,o,a=e.children;try{for(var s=Object(i.__values)(a.entries()),c=s.next();!c.done;c=s.next()){var u=Object(i.__read)(c.value,2),l=u[0],h=u[1];if(ge(h),h.type===le){var p=!1;try{for(var f=(n=void 0,Object(i.__values)(h.children)),d=f.next();!d.done;d=f.next()){(v=d.value).type!==pe&&v.type!==he&&v.type!==fe||(p=!0,v.hydrate=!0)}}catch(e){n={error:e}}finally{try{d&&!d.done&&(o=f.return)&&o.call(f)}finally{if(n)throw n.error}}if(p&&1===h.children.length){var v=h.children[0];a[l]=v}}}}catch(e){t={error:e}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}}function _e(e){return e}function me(e){return we(e.root),e}function we(e){var t,r;xe(e.children,(function(n){if(we(n),n.type!==de||!n.children.some((function(e){return e.type===fe})))return!0;if(r){var i=n;!function(e,t){var r=e;for(;e.nextFilter;)r=e.nextFilter;r.nextFilter=t}(r,i),i.regroup=e.type===ce}else t=n;return r=n,!1})),t&&e.children.push(t)}function xe(e,t){for(var r=e,n=0,i=r.length-1;n<=i;){var o=r[n];t(o)?n+=1:(r[n]=r[i],r[i]=o,i-=1)}return r.splice(i+1)}function Oe(e){return je(e.root),e}function je(e){var t,r,n=e.children;try{for(var o=Object(i.__values)(n.entries()),a=o.next();!a.done;a=o.next()){var s=Object(i.__read)(a.value,2),c=s[0],u=s[1];if(je(u),u.type===ue){var l=u.children.find((function(e){var t=e.type;return[pe,he].includes(t)}));if(l){var h=xe(u.children,(function(e){return e.type!==de}));if(h.length){var p={type:le,collectionSchema:l.collectionSchema,children:[]};n[c]=Se.apply(void 0,Object(i.__spreadArray)(Object(i.__spreadArray)([],Object(i.__read)(h)),[p,u]))}}}}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}}function Ce(e){return[o.e.COUNT,o.e.KEYS].includes(e.aggregate)||Me((function(e){e.type!==pe&&e.type!==he||(e.hydrate=!0)}),e.root),e}function Ae(e){return Me((function(e){var t,r,n,o,a;if(e.type===ue){var s=Number.MIN_SAFE_INTEGER;try{for(var c=Object(i.__values)(e.children),u=c.next();!u.done;u=c.next()){var l=u.value,h=Number.MIN_SAFE_INTEGER;l.type===pe&&(h=0),l.type===he&&l.index.priority&&(h=l.index.priority),s=Math.max(s,h)}}catch(e){t={error:e}}finally{try{u&&!u.done&&(r=c.return)&&r.call(c)}finally{if(t)throw t.error}}var p=e.children;try{for(var f=Object(i.__values)(p.entries()),d=f.next();!d.done;d=f.next()){var v=Object(i.__read)(d.value,2),y=v[0];if((l=v[1]).type===he)(h=null!==(a=l.index.priority)&&void 0!==a?a:Number.MIN_SAFE_INTEGER)<s&&(p[y]=Ee(l))}}catch(e){n={error:e}}finally{try{d&&!d.done&&(o=f.return)&&o.call(f)}finally{if(n)throw n.error}}}}),e.root),e}function Ee(e){return{path:e.index.path,intervals:e.intervals,comparer:e.comparer,type:N.FILTER,regroup:!1,children:[{type:N.SCAN_ALL,collectionSchema:e.collectionSchema,comparer:e.comparer,hydrate:!0,children:[]}]}}function Me(e,t,r,n){var o,a;void 0===r&&(r=null),void 0===n&&(n=-1);var s=t.children;try{for(var c=Object(i.__values)(s.entries()),u=c.next();!u.done;u=c.next()){var l=Object(i.__read)(u.value,2),h=l[0];Me(e,l[1],t,h)}}catch(e){o={error:e}}finally{try{u&&!u.done&&(a=c.return)&&a.call(c)}finally{if(o)throw o.error}}e(t,r,n)}function Se(){for(var e,t,r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];var o=Object(i.__read)(r),a=o[0],s=o.slice(1),c=a;try{for(var u=Object(i.__values)(s),l=u.next();!l.done;l=u.next()){var h=l.value;c.children=[h],c=h}}catch(t){e={error:t}}finally{try{l&&!l.done&&(t=u.return)&&t.call(u)}finally{if(e)throw e.error}}return a}var De,Ie=function(){function e(){}return e.prototype.optimize=function(e){var t=[Ae,be,me,ve,Oe,_e,ve,be,Ce];return this.applyAllRules(t,e)},e.prototype.applyAllRules=function(e,t){return e.reduce((function(e,t){return t(e)}),t)},e}(),Ne=function(){function e(e){void 0===e&&(e=new Map),this.query={offset:0,limit:void 0,order:void 0,whereClauses:[]},this.aliasMap=e}return e.fromRawQuery=function(t,r){var n,o;void 0===r&&(r=new Map);var a=new e(r),s=t.offset,c=t.limit,u=t.order,l=t.whereClauses;a.setOffset(s),a.setLimit(c),u&&a.setOrderBy(u.path,u.type);try{for(var h=Object(i.__values)(l),p=h.next();!p.done;p=h.next()){var f=p.value;a.addWhereClause(f)}}catch(e){n={error:e}}finally{try{p&&!p.done&&(o=h.return)&&o.call(h)}finally{if(n)throw n.error}}return a},e.prototype.setOffset=function(e){this.query.offset=e},e.prototype.setLimit=function(e){this.query.limit=e},e.prototype.setRange=function(e,t){void 0===e&&(e=0),this.query.offset=e,this.query.limit=t!==o.k?Math.max(0,t-e):o.k},e.prototype.setOrderBy=function(e,t){this.query.order={path:e,type:t||o.i.ASCENDING}},e.prototype.addWhereClause=function(e){var t,r,n;if(this.isValidWhereClause(e)){var o={};try{for(var a=Object(i.__values)(Object.entries(e)),s=a.next();!s.done;s=a.next()){var c=Object(i.__read)(s.value,2),u=c[0],l=c[1];if(void 0!==l)o[null!==(n=this.aliasMap.get(u))&&void 0!==n?n:u]=l}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}this.query.whereClauses.push(o)}},e.prototype.clone=function(t){return void 0===t&&(t=this.aliasMap),e.fromRawQuery(this.query,t)},e.prototype.build=function(){return this.query},e.prototype.isValidWhereClause=function(e){return!!e&&Object.keys(e).length>=0},e}();!function(e){e.DISABLED="disabled",e.ALL="all"}(De||(De={}));var Te=function(){function e(e,t){this.collectionName=e,this.context=t.context}return e.toggleOptimization=function(t){e.optimization=t?De.ALL:De.DISABLED},e.getOptimizationMode=function(){return e.optimization},e.prototype.exec=function(e,t){return Object(i.__awaiter)(this,void 0,void 0,(function(){var r,n,a,s,c,u,l,h;return Object(i.__generator)(this,(function(p){switch(p.label){case 0:return[4,this.context.getTransactionGenerator([this.collectionName],o.j.READ_ONLY)];case 1:return r=p.sent().startTransaction(),[4,this.getModel()];case 2:return n=p.sent(),a=this.getAliasMap(n.class),s=Ne.fromRawQuery(e,a).build(),(c=r.table(this.collectionName)).supports("query")&&s.whereClauses.length<=1?t!==o.e.VALUES?[3,4]:[4,c.query(s,t)]:[3,7];case 3:return[2,p.sent().map((function(e){var t;return null!==(t=P(e,n.class))&&void 0!==t?t:void 0}))];case 4:return t!==o.e.ENTRIES?[3,6]:[4,c.query(s,t)];case 5:return[2,p.sent().map((function(e){var t,r=Object(i.__read)(e,2);return[r[0],null!==(t=P(r[1],n.class))&&void 0!==t?t:void 0]}))];case 6:return[2,c.query(s,t)];case 7:return[4,this.getQueryPlan(s,t)];case 8:return u=p.sent(),[4,new re(u,r).exec()];case 9:return l=i.__read.apply(void 0,[p.sent(),1]),h=l[0],t===o.e.COUNT?[2,h.length]:t===o.e.KEYS?[2,h.map((function(e){return Object(i.__read)(e,1)[0]}))]:t===o.e.VALUES?[2,h.map((function(e){var t;return null!==(t=P(Object(i.__read)(e,2)[1],n.class))&&void 0!==t?t:void 0}))]:[2,h.map((function(e){var t,r=Object(i.__read)(e,2);return[r[0],null!==(t=P(r[1],n.class))&&void 0!==t?t:void 0]}))]}}))}))},e.prototype.conditions=function(e){return this.getRewriter().rewrite(e)},e.prototype.explain=function(e,t){return Object(i.__awaiter)(this,void 0,void 0,(function(){return Object(i.__generator)(this,(function(r){switch(r.label){case 0:return[4,this.getQueryPlan(e,t)];case 1:return[2,r.sent()]}}))}))},e.prototype.getQueryPlan=function(t,r){return Object(i.__awaiter)(this,void 0,void 0,(function(){var n,o,a,s,c,u,l;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return[4,this.getRewriter()];case 1:return n=i.sent(),[4,this.getEliminator()];case 2:return o=i.sent(),[4,this.getPlanner()];case 3:return a=i.sent(),[4,this.getBinder()];case 4:return s=i.sent(),[4,this.getOptimizer()];case 5:return c=i.sent(),u=n.rewrite(t),u=s.bind(u),u=o.eliminate(u),l=a.plan(u,r),[2,e.optimization===De.DISABLED?l:c.optimize(l)]}}))}))},e.prototype.getAliasMap=function(e){var t,r,n=new Map,o=j.getTableInfo(e.prototype);if(!o)return n;try{for(var a=Object(i.__values)(o.properties.values()),s=a.next();!s.done;s=a.next()){var c=s.value;c.alias&&n.set(c.name,c.alias)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return n},e.prototype.getModel=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){return Object(i.__generator)(this,(function(e){return[2,this.context.waitForModelRegistered(this.collectionName)]}))}))},e.prototype.getPlanner=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e;return Object(i.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.getModel()];case 1:return e=t.sent(),[2,new oe(e.schema,this.context.comparer)]}}))}))},e.prototype.getRewriter=function(){return new ne(this.context.comparer)},e.prototype.getEliminator=function(){return new ae},e.prototype.getBinder=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e;return Object(i.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.getModel()];case 1:return e=t.sent(),[2,new ie(e.schema)]}}))}))},e.prototype.getOptimizer=function(){return new Ie},e.optimization=De.ALL,Object(i.__decorate)([se()],e.prototype,"getModel",null),Object(i.__decorate)([se()],e.prototype,"getPlanner",null),Object(i.__decorate)([se()],e.prototype,"getRewriter",null),Object(i.__decorate)([se()],e.prototype,"getEliminator",null),Object(i.__decorate)([se()],e.prototype,"getBinder",null),Object(i.__decorate)([se()],e.prototype,"getOptimizer",null),e}(),Be=function(){function e(e,t){this.name=e,this.options=t,this.contextGenerator=t.contextGenerator,this.queryBuilder=new Ne,this.patch()}return e.toggleOptimization=function(e){return Te.toggleOptimization(e)},e.prototype.skip=function(e){return this.queryBuilder.setOffset(e),this},e.prototype.take=function(e){return this.queryBuilder.setLimit(e),this},e.prototype.slice=function(e,t){return this.queryBuilder.setRange(e,t),this},e.prototype.orderBy=function(e,t){return this.queryBuilder.setOrderBy(e,t),this},e.prototype.where=function(e){return this.queryBuilder.addWhereClause(e),this},e.prototype.or=function(e){return this.queryBuilder.addWhereClause(e),this},e.prototype.conditions=function(){var e=this.contextGenerator.spawnContext();return new Te(this.name,{context:e}).conditions(this.queryBuilder.build())},e.prototype.clone=function(){var t=new e(this.name,this.options);return t.queryBuilder=this.queryBuilder.clone(),t},e.prototype.explain=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t;return Object(i.__generator)(this,(function(r){return t=this.contextGenerator.spawnContext(),[2,new Te(this.name,{context:t}).explain(this.queryBuilder.build(),e)]}))}))},e.prototype.count=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return Object(i.__generator)(this,(function(r){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(t,void 0,void 0,(function(){return Object(i.__generator)(this,(function(t){return[2,new Te(this.name,{context:e}).exec(this.queryBuilder.build(),o.e.COUNT)]}))}))}))]}))}))},e.prototype.entries=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return Object(i.__generator)(this,(function(r){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(t,void 0,void 0,(function(){return Object(i.__generator)(this,(function(t){return[2,new Te(this.name,{context:e}).exec(this.queryBuilder.build(),o.e.ENTRIES)]}))}))}))]}))}))},e.prototype.keys=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return Object(i.__generator)(this,(function(r){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(t,void 0,void 0,(function(){return Object(i.__generator)(this,(function(t){return[2,new Te(this.name,{context:e}).exec(this.queryBuilder.build(),o.e.KEYS)]}))}))}))]}))}))},e.prototype.values=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return Object(i.__generator)(this,(function(r){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(t,void 0,void 0,(function(){return Object(i.__generator)(this,(function(t){return[2,new Te(this.name,{context:e}).exec(this.queryBuilder.build(),o.e.VALUES)]}))}))}))]}))}))},e.prototype.first=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return Object(i.__generator)(this,(function(r){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(t,void 0,void 0,(function(){var t,r;return Object(i.__generator)(this,(function(n){switch(n.label){case 0:return[4,new Te(this.name,{context:e}).exec(this.queryBuilder.build(),o.e.VALUES)];case 1:return t=n.sent(),[2,null!==(r=t[0])&&void 0!==r?r:null]}}))}))}))]}))}))},e.prototype.last=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return Object(i.__generator)(this,(function(r){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(t,void 0,void 0,(function(){var t,r;return Object(i.__generator)(this,(function(n){switch(n.label){case 0:return[4,new Te(this.name,{context:e}).exec(this.queryBuilder.build(),o.e.VALUES)];case 1:return t=n.sent(),[2,null!==(r=t[t.length-1])&&void 0!==r?r:null]}}))}))}))]}))}))},e.prototype.update=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r,n=this;return Object(i.__generator)(this,(function(a){switch(a.label){case 0:return[4,this.entries()];case 1:return t=a.sent(),[2,(r=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(n,void 0,void 0,(function(){var n,a,s,c,u,l,h,p,f,d,v,y,b;return Object(i.__generator)(this,(function(g){switch(g.label){case 0:return n=[],[4,r.getTransactionGenerator([this.name],o.j.READ_WRITE)];case 1:a=g.sent().startTransaction(),s=a.table(this.name),g.label=2;case 2:g.trys.push([2,8,9,10]),c=Object(i.__values)(t),u=c.next(),g.label=3;case 3:return u.done?[3,7]:(l=Object(i.__read)(u.value,2),h=l[0],p=l[1],[4,s.openCursor(h)]);case 4:return(f=g.sent())?(d=e(p),[4,f.update(k(d))]):[3,6];case 5:g.sent(),n.push(h),g.label=6;case 6:return u=c.next(),[3,3];case 7:return[3,10];case 8:return v=g.sent(),y={error:v},[3,10];case 9:try{u&&!u.done&&(b=c.return)&&b.call(c)}finally{if(y)throw y.error}return[7];case 10:return[2,n]}}))}))}))]}}))}))},e.prototype.clear=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,t,r=this;return Object(i.__generator)(this,(function(n){switch(n.label){case 0:return[4,this.keys()];case 1:return e=n.sent(),[2,(t=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r,n,a,s,c,u,l,h,p,f;return Object(i.__generator)(this,(function(d){switch(d.label){case 0:return r=[],[4,t.getTransactionGenerator([this.name],o.j.READ_WRITE)];case 1:return n=d.sent().startTransaction(),(a=n.table(this.name)).supports("bulkDelete")?[4,a.bulkDelete(e)]:[3,3];case 2:return d.sent(),[2,e];case 3:d.trys.push([3,9,10,11]),s=Object(i.__values)(e),c=s.next(),d.label=4;case 4:return c.done?[3,8]:(u=c.value,[4,a.openCursor(u)]);case 5:return(l=d.sent())?[4,l.delete()]:[3,7];case 6:d.sent(),r.push(u),d.label=7;case 7:return c=s.next(),[3,4];case 8:return[3,11];case 9:return h=d.sent(),p={error:h},[3,11];case 10:try{c&&!c.done&&(f=s.return)&&f.call(s)}finally{if(p)throw p.error}return[7];case 11:return[2,r]}}))}))}))]}}))}))},e.prototype.patch=function(){var e=this.options.aspects;e.update.patch(this,"update"),e.clear.patch(this,"clear"),e.count.patch(this,"count"),e.entries.patch(this,"entries"),e.keys.patch(this,"keys"),e.values.patch(this,"values"),e.first.patch(this,"first"),e.last.patch(this,"last"),e.skip.patch(this,"skip"),e.take.patch(this,"take"),e.slice.patch(this,"slice"),e.orderBy.patch(this,"orderBy"),e.where.patch(this,"where"),e.or.patch(this,"or")},e}(),Re=function(){function e(e,t){this.name=e,this.aspects=t.aspects,this.contextGenerator=t.contextGenerator,this.unsliced=new Be(e,t),this.patch()}return e.prototype.skip=function(e){return this.unsliced.clone().skip(e)},e.prototype.take=function(e){return this.unsliced.clone().take(e)},e.prototype.slice=function(e,t){return this.unsliced.clone().slice(e,t)},e.prototype.orderBy=function(e,t){return this.unsliced.clone().orderBy(e,t)},e.prototype.where=function(e){return this.unsliced.clone().where(e)},e.prototype.or=function(e){return this.unsliced.clone().or(e)},e.prototype.update=function(e){return this.unsliced.update(e)},e.prototype.clear=function(){return this.unsliced.clear()},e.prototype.count=function(){return this.unsliced.count()},e.prototype.entries=function(){return this.unsliced.entries()},e.prototype.keys=function(){return this.unsliced.keys()},e.prototype.values=function(){return this.unsliced.values()},e.prototype.first=function(){return this.unsliced.first()},e.prototype.last=function(){return this.unsliced.last()},e.prototype.get=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r=this;return Object(i.__generator)(this,(function(n){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r,n,a;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return[4,t.waitForModelRegistered(this.name)];case 1:return r=i.sent(),[4,t.getTransactionGenerator([this.name],o.j.READ_ONLY)];case 2:return n=i.sent().startTransaction(),[4,n.table(this.name).get(e)];case 3:return[2,(a=i.sent())?P(a,r.class):null]}}))}))}))]}))}))},e.prototype.has=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r=this;return Object(i.__generator)(this,(function(n){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r;return Object(i.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.getTransactionGenerator([this.name],o.j.READ_ONLY)];case 1:return r=n.sent().startTransaction(),[4,r.table(this.name).openCursor(e)];case 2:return[2,!!n.sent()]}}))}))}))]}))}))},e.prototype.delete=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r=this;return Object(i.__generator)(this,(function(n){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r,n,a;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return[4,t.getTransactionGenerator([this.name],o.j.READ_WRITE)];case 1:return r=i.sent().startTransaction(),[4,(n=r.table(this.name)).openCursor(e)];case 2:return a=i.sent(),[4,n.delete(e)];case 3:return i.sent(),[2,a?e:null]}}))}))}))]}))}))},e.prototype.insert=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r=this;return Object(i.__generator)(this,(function(n){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r;return Object(i.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.getTransactionGenerator([this.name],o.j.READ_WRITE)];case 1:return r=n.sent().startTransaction(),[4,r.table(this.name).insert(k(e))];case 2:return[2,n.sent()]}}))}))}))]}))}))},e.prototype.upsert=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r=this;return Object(i.__generator)(this,(function(n){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r;return Object(i.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.getTransactionGenerator([this.name],o.j.READ_WRITE)];case 1:return r=n.sent().startTransaction(),[4,r.table(this.name).upsert(k(e))];case 2:return[2,n.sent()]}}))}))}))]}))}))},e.prototype.bulkInsert=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r=this;return Object(i.__generator)(this,(function(n){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r,n,a,s,c,u,l,h,p,f;return Object(i.__generator)(this,(function(d){switch(d.label){case 0:return[4,t.getTransactionGenerator([this.name],o.j.READ_WRITE)];case 1:r=d.sent().startTransaction(),n=[],a=r.table(this.name),d.label=2;case 2:d.trys.push([2,7,8,9]),s=Object(i.__values)(e),c=s.next(),d.label=3;case 3:return c.done?[3,6]:(u=c.value,[4,a.insert(k(u))]);case 4:l=d.sent(),n.push(l),d.label=5;case 5:return c=s.next(),[3,3];case 6:return[3,9];case 7:return h=d.sent(),p={error:h},[3,9];case 8:try{c&&!c.done&&(f=s.return)&&f.call(s)}finally{if(p)throw p.error}return[7];case 9:return[2,n]}}))}))}))]}))}))},e.prototype.bulkUpsert=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){var t,r=this;return Object(i.__generator)(this,(function(n){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r;return Object(i.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.getTransactionGenerator([this.name],o.j.READ_WRITE)];case 1:return r=n.sent().startTransaction(),[2,r.table(this.name).bulkUpsert(e.map((function(e){return k(e)})))]}}))}))}))]}))}))},e.prototype.conditions=function(){return this.unsliced.conditions()},e.prototype.patch=function(){this.aspects.get.patch(this,"get"),this.aspects.has.patch(this,"has"),this.aspects.delete.patch(this,"delete"),this.aspects.insert.patch(this,"insert"),this.aspects.upsert.patch(this,"upsert"),this.aspects.bulkInsert.patch(this,"bulkInsert"),this.aspects.bulkUpsert.patch(this,"bulkUpsert")},e}(),ke=function(){function e(e,t){this.collectionMap=new Map,this.storage=e,this.eventBus=t}return e.prototype.getCollection=function(e,t){if(this.collectionMap.has(e))return this.collectionMap.get(e);var r=this.createCollection(e,t);return this.collectionMap.set(e,r),this.eventBus.emit(I.CollectionCreated,{collectionName:e,context:t.spawnContext()}),r},e.prototype.createCollection=function(e,t){var r=this.storage.aspects.collection;return new Re(e,{contextGenerator:t,aspects:r})},e}(),Pe=r("2a19a81d63");function Le(){return{timings:new Map,counters:new Map,messages:new Map,errors:new Map,flags:new Map,data:new Map}}var Fe,qe=function(){function e(e,t){this.storage=e,this.eventBus=t,this.plugins=[]}return e.prototype.add=function(){for(var e,t,r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];try{for(var o=Object(i.__values)(r),a=o.next();!a.done;a=o.next()){var s=a.value;this.plugins.push(s),s.register(this.storage),this.eventBus.emit(D.RegisterPlugin,s)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}},e}(),Ve=qe,Ge=r("e93cc9d9b1"),Ue=o.d.name;!function(e){e.SYSTEM_TABLE="system_table",e.SCAN_EXISTING_TABLE="scan_exists_table"}(Fe||(Fe={}));var Ke=function(){function e(){}return e.hasSystemTable=function(e){return e.tableNames.includes(Ue)},e.getDatabaseSchema=function(t,r,n){return Object(i.__awaiter)(this,void 0,void 0,(function(){var a,s,c,u,l;return Object(i.__generator)(this,(function(h){switch(h.label){case 0:return[4,r.openDB(t,{name:t,collections:[o.d]})];case 1:a=h.sent(),s=!1,h.label=2;case 2:return h.trys.push([2,,10,11]),a.tableNames.length?[3,4]:(a.close(),s=!0,[4,r.deleteDB(t)]);case 3:return h.sent(),[2,{schema:{name:this.name,version:0,collections:[]},from:"scan_exists_table"}];case 4:return this.hasSystemTable(a)?[3,6]:[4,e.getDatabaseSchemaByScanningTableStructure(n.collections.map((function(e){return e.name})),a)];case 5:return[2,{schema:h.sent(),from:"scan_exists_table"}];case 6:return[4,a.transaction([Ue],o.j.READ_ONLY)];case 7:return c=h.sent(),[4,c.table(Ue).getAll()];case 8:return u=h.sent()||[],l={name:this.name,version:a.version,collections:Object(i.__spreadArray)(Object(i.__spreadArray)([],Object(i.__read)(u)),[this.getSystemTableSchema()])},[4,c.commit()];case 9:return h.sent(),[2,{schema:l,from:"system_table"}];case 10:return s||a.close(),[7];case 11:return[2]}}))}))},e.getSystemTableSchema=function(){return o.d},e.updateSchemaChange=function(e,t,r,n){return Object(i.__awaiter)(this,void 0,void 0,(function(){var a,s,c,u,l,h,p,f,d,v,y,b,g,m,w,x,O,j,C,A,E,M,S;return Object(i.__generator)(this,(function(D){switch(D.label){case 0:return a=t.table(Ue),n?[4,a.bulkUpsert(r.schema.expect.collections.filter((function(e){return e.name!==Ue})))]:[3,2];case 1:return D.sent(),[2];case 2:D.trys.push([2,27,,29]),s=o.h.databaseDiff(r.schema.actual,r.schema.expect),c=s.added.filter((function(e){return e.name!==Ue})),D.label=3;case 3:D.trys.push([3,8,9,10]),u=Object(i.__values)(c),l=u.next(),D.label=4;case 4:return l.done?[3,7]:((d=l.value).dataVersion=e,[4,a.upsert(d)]);case 5:D.sent(),D.label=6;case 6:return l=u.next(),[3,4];case 7:return[3,10];case 8:return h=D.sent(),j={error:h},[3,10];case 9:try{l&&!l.done&&(C=u.return)&&C.call(u)}finally{if(j)throw j.error}return[7];case 10:D.trys.push([10,15,16,17]),p=Object(i.__values)(s.deleted),f=p.next(),D.label=11;case 11:return f.done?[3,14]:(d=f.value,[4,a.delete(d.name)]);case 12:D.sent(),D.label=13;case 13:return f=p.next(),[3,11];case 14:return[3,17];case 15:return v=D.sent(),A={error:v},[3,17];case 16:try{f&&!f.done&&(E=p.return)&&E.call(p)}finally{if(A)throw A.error}return[7];case 17:y=s.different.filter((function(e){return!!e.index})),b=function(e){var t,r,n;return Object(i.__generator)(this,(function(o){switch(o.label){case 0:return[4,a.get(e.collection)];case 1:return t=o.sent(),r=[],n=t.indices.filter((function(t){return!e.index.deleted.some((function(e){return e.name===t.name}))})),r.push.apply(r,Object(i.__spreadArray)([],Object(i.__read)(e.index.added))),r.push.apply(r,Object(i.__spreadArray)([],Object(i.__read)(n))),t.index=r,[4,a.upsert(t)];case 2:return o.sent(),[2]}}))},D.label=18;case 18:D.trys.push([18,23,24,25]),g=Object(i.__values)(y),m=g.next(),D.label=19;case 19:return m.done?[3,22]:(w=m.value,[5,b(w)]);case 20:D.sent(),D.label=21;case 21:return m=g.next(),[3,19];case 22:return[3,25];case 23:return x=D.sent(),M={error:x},[3,25];case 24:try{m&&!m.done&&(S=g.return)&&S.call(g)}finally{if(M)throw M.error}return[7];case 25:return[4,t.commit()];case 26:if(!D.sent())throw new _;return[3,29];case 27:return O=D.sent(),[4,t.rollback()];case 28:throw D.sent(),O;case 29:return[2]}}))}))},e.updateCollectionDataVersion=function(e,t,r){return Object(i.__awaiter)(this,void 0,void 0,(function(){var n,o,a;return Object(i.__generator)(this,(function(s){switch(s.label){case 0:return[4,(n=t.table(Ue)).get(j.getTableName(r))];case 1:if(o=s.sent(),a=j.getTableInfo(r.prototype),!o)throw new Error("get target table system info error!");if(!a)throw new h(r.name);return o.dataVersion=e,o.properties=Object(i.__spreadArray)([],Object(i.__read)(a.properties.values())).map((function(e){return e.name})),[4,n.upsert(o)];case 2:return s.sent(),[2]}}))}))},e.getTableDataVersion=function(e,t){return Object(i.__awaiter)(this,void 0,void 0,(function(){return Object(i.__generator)(this,(function(r){switch(r.label){case 0:return[4,t.table(Ue).get(e)];case 1:return[2,r.sent().dataVersion]}}))}))},e.getDatabaseSchemaByScanningTableStructure=function(e,t){return Object(i.__awaiter)(this,void 0,void 0,(function(){var r,n,a,s,c,u,l,h,p,f,d,v,y,b,g,_;return Object(i.__generator)(this,(function(m){switch(m.label){case 0:r=t.tableNames.filter((function(t){return e.includes(t)})),n=[],m.label=1;case 1:m.trys.push([1,6,7,8]),a=Object(i.__values)(r),s=a.next(),m.label=2;case 2:return s.done?[3,5]:(c=s.value,[4,t.table(c,o.j.READ_ONLY)]);case 3:u=m.sent(),l={name:c,key:u.autoIncrement?{generator:o.c.AutoIncrement}:{path:u.keyPath},indices:[],properties:[]};try{for(g=void 0,h=Object(i.__values)(u.indexNames),p=h.next();!p.done;p=h.next())f=p.value,d=u.index(f),l.indices.push({name:f,path:d.keyPath,unique:d.unique})}catch(e){g={error:e}}finally{try{p&&!p.done&&(_=h.return)&&_.call(h)}finally{if(g)throw g.error}}n.push(l),m.label=4;case 4:return s=a.next(),[3,2];case 5:return[3,8];case 6:return v=m.sent(),y={error:v},[3,8];case 7:try{s&&!s.done&&(b=a.return)&&b.call(a)}finally{if(y)throw y.error}return[7];case 8:return[2,{name:t.name,version:t.version,collections:n}]}}))}))},e}(),We=function(){function e(e){this.schemaActionHandlerMap=new Map,this.dataActionHandlerMap=new Map,this.schemaActionHandlerMap.set(o.g.CreateCollection,this.performCreateCollectionAction.bind(this)),this.schemaActionHandlerMap.set(o.g.DropCollection,this.performDropCollectionAction.bind(this)),this.schemaActionHandlerMap.set(o.g.CreateIndex,this.performCreateIndexAction.bind(this)),this.schemaActionHandlerMap.set(o.g.DropIndex,this.performDropIndexAction.bind(this)),this.dataActionHandlerMap.set(o.a.DropProperty,this.performDropPropertyAction.bind(this)),this.dataActionHandlerMap.set(o.a.ClearData,this.performClearDataAction.bind(this)),this.dataActionHandlerMap.set(o.a.ReplaceData,this.performReplaceDataAction.bind(this)),e.executeDataAction.patch(this,"executeDataAction"),e.executeSchemaAction.patch(this,"executeSchemaAction")}return e.prototype.executeSchemaAction=function(e,t,r){var n=this.schemaActionHandlerMap.get(r.type);if(n){if(t.mode!==o.j.VERSION_CHANGE)throw new l(r.type);return n(e,t,r)}},e.prototype.executeDataAction=function(e,t,r){return Object(i.__awaiter)(this,void 0,void 0,(function(){var n;return Object(i.__generator)(this,(function(i){return(n=this.dataActionHandlerMap.get(r.type))?[2,n(e,t,r)]:[2]}))}))},e.prototype.performCreateIndexAction=function(e,t,r){t.table(r.collection).createIndex(r.name,r.attributes.path,{unique:r.attributes.unique})},e.prototype.performDropIndexAction=function(e,t,r){t.table(r.collection).deleteIndex(r.name)},e.prototype.performDropCollectionAction=function(e,t,r){e.deleteTable(r.name)},e.prototype.performCreateCollectionAction=function(e,t,r){var n,i;e.createTable(r.name,{keyPath:null===(n=r.attributes.key)||void 0===n?void 0:n.path,autoIncrement:(null===(i=r.attributes.key)||void 0===i?void 0:i.generator)===o.c.AutoIncrement})},e.prototype.performClearDataAction=function(e,t,r){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,n;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return e=t.table(r.collection),r.filter?[3,2]:[4,e.clear()];case 1:return i.sent(),[2];case 2:return[4,e.openCursor()];case 3:n=i.sent(),i.label=4;case 4:return n?r.filter(n.value())?[4,n.delete()]:[3,6]:[3,8];case 5:i.sent(),i.label=6;case 6:return[4,n.next()];case 7:return n=i.sent(),[3,4];case 8:return[2]}}))}))},e.prototype.performDropPropertyAction=function(e,t,r){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,n;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return[4,t.table(r.collection).openCursor()];case 1:e=i.sent(),i.label=2;case 2:return e?((n=e.value())[r.path]=void 0,[4,e.update(n)]):[3,5];case 3:return i.sent(),[4,e.next()];case 4:return e=i.sent(),[3,2];case 5:return[2]}}))}))},e.prototype.performReplaceDataAction=function(e,t,r){var n;return Object(i.__awaiter)(this,void 0,void 0,(function(){var e,o;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return[4,t.table(r.collection).openCursor()];case 1:e=i.sent(),i.label=2;case 2:return e?(o=e.value(),r.filter&&!(null===(n=r.filter)||void 0===n?void 0:n.call(this,o))?[3,4]:[4,e.update(r.replacer(o))]):[3,6];case 3:i.sent(),i.label=4;case 4:return[4,e.next()];case 5:return e=i.sent(),[3,2];case 6:return[2]}}))}))},e}(),He=function(){function e(e){this.collection=e,this.versionActionsMap=new Map}return e.prototype.getVersionActionsMap=function(){return this.versionActionsMap},e.prototype.version=function(e){var t=this,r={update:function(n){return t.pushAction(e,{type:o.a.ReplaceData,replacer:n,collection:t.collection}),r},delete:function(n){return t.pushAction(e,{filter:n,type:o.a.ClearData,collection:t.collection}),r}};return r},e.prototype.pushAction=function(e,t){var r=this.versionActionsMap.get(e)||[];r.push(t),this.versionActionsMap.set(e,r)},e}(),ze=function(){function e(e,t,r){this.expectedSchema=e,this.actualSchema=t,this.modelClass=r}return e.prototype.plan=function(){var e=this.actualSchema.dataVersion||0,t=this.expectedSchema.dataVersion||1;if(e===t)return[];var r=[],n=this.getManualMigrationActions(e,t);r.push.apply(r,Object(i.__spreadArray)([],Object(i.__read)(n)));var o=this.getAutoMigrationActions();return r.push.apply(r,Object(i.__spreadArray)([],Object(i.__read)(o))),[{schema:{actions:[]},data:{actions:r}}]},e.prototype.getManualMigrationActions=function(e,t){var r,n,i=new He(j.getTableName(this.modelClass));return null===(n=(r=this.modelClass).onDataUpgrade)||void 0===n||n.call(r,e,t,i),this.getRangeDataAction(e,t,i.getVersionActionsMap())},e.prototype.getAutoMigrationActions=function(){var e,t,r=this,n=[],a=this.actualSchema.properties.filter((function(e){return!r.expectedSchema.properties.includes(e)}));try{for(var s=Object(i.__values)(a),c=s.next();!c.done;c=s.next()){var u=c.value;n.push({type:o.a.DropProperty,collection:j.getTableName(this.modelClass),path:u})}}catch(t){e={error:t}}finally{try{c&&!c.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}return n},e.prototype.getRangeDataAction=function(e,t,r){for(var n=[],o=e;o<=t;o++)n.push.apply(n,Object(i.__spreadArray)([],Object(i.__read)(r.get(o)||[])));return n},e}(),Qe=function(){function e(e){this.migrationManager=e,this.upgradedFlag=new Map}return e.prototype.executeDataUpgrade=function(e,t,r,n){return void 0===n&&(n=function(){}),Object(i.__awaiter)(this,void 0,void 0,(function(){var o,a;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return o=j.getTableName(e),this.upgradedFlag.get(o)?[2]:(a=this.getCollectionSchema(o,r),this.isNeedExecuteDataUpgrade(a.expect,a.actual)?[4,this.executeUpgrade(o,t,r,a.expect,a.actual,e)]:(this.upgradedFlag.set(o,!0),[2,n()]));case 1:return i.sent(),this.upgradedFlag.set(o,!0),[2,n()]}}))}))},e.prototype.isNeedExecuteDataUpgrade=function(e,t){return!(!(null==t?void 0:t.dataVersion)||e.dataVersion===t.dataVersion)},e.prototype.executeUpgrade=function(e,t,r,n,a,s){return Object(i.__awaiter)(this,void 0,void 0,(function(){var c,l,h,p,f,d;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return c=new ze(n,a,s),this.migrationManager.use(c),l=this.migrationManager.buildMigration(r),[4,t.transaction([e,Ke.getSystemTableSchema().name],o.j.READ_WRITE)];case 1:h=i.sent(),p=!1,i.label=2;case 2:return i.trys.push([2,6,8,11]),f=r.schema.expect.version||1,[4,Ke.getTableDataVersion(j.getTableName(s),h)];case 3:return i.sent()===f?[2]:[4,this.migrationManager.executeDataMigration(t,l,h)];case 4:return i.sent(),[4,Ke.updateCollectionDataVersion(f,h,s)];case 5:return i.sent(),[3,11];case 6:return d=i.sent(),p=!0,[4,h.rollback()];case 7:throw i.sent(),new u({oldVersion:a.dataVersion,newVersion:n.dataVersion},d);case 8:return p?[3,10]:[4,h.commit()];case 9:i.sent(),i.label=10;case 10:return[7];case 11:return[2]}}))}))},e.prototype.getCollectionSchema=function(e,t){var r=t.schema,n=r.expect,i=r.actual,o=n.collections.filter((function(t){return t.name===e})),a=i.collections.filter((function(t){return t.name===e}));if(1!==o.length)throw new c(e);return{expect:o[0],actual:a.length?a[0]:void 0}},e}(),Ye=function(){function e(e,t,r){var n=this;this.planner=new Ge.a,this.actualDBSchema=null,this.actualDBSchemaFrom=null,this.lazyMigrationProcessor=new Qe(this),this.handleCollectionCreated=function(e){var t=e.collectionName,r=e.context;n.safeExecuteDataUpgrade(r,t)},this.handleStartTransaction=function(e){var t,r,o=e.collectionNames,a=e.context;try{for(var s=Object(i.__values)(o),c=s.next();!c.done;c=s.next()){var u=c.value;n.safeExecuteDataUpgrade(a,u)}}catch(e){t={error:e}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}},this.eventBus=e,this.eventBus.on(I.CollectionCreated,this.handleCollectionCreated),this.eventBus.on(I.StartTransaction,this.handleStartTransaction),this.schemaProvider=t,this.actionExecutor=new We(r.actionExecutor),this.applyAspectPatch(r)}return e.prototype.use=function(e){this.planner=e},e.prototype.prepareAutoUpgradeHandler=function(e,t){return Object(i.__awaiter)(this,void 0,void 0,(function(){var r,n,o,a,s,c=this;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return r=this.schemaProvider.getDatabaseSchema(),[4,Ke.getDatabaseSchema(e,t,r)];case 1:return n=i.sent(),o=n.schema,a=n.from,this.actualDBSchema=o,this.actualDBSchemaFrom=a,this.log("getDatabaseSchema",this.actualDBSchema),s=this.buildMigration({schema:{expect:r,actual:this.actualDBSchema}}),[2,function(e,t,r,n){c.eventBus.emit(D.SchemaMigrationStart),c.executeSchemaMigration(e,s,n),c.updateMigrationChangeInfo(n).catch((function(e){c.emitError(new m(e))})),c.eventBus.emit(D.SchemaMigrationEnd)}]}}))}))},e.prototype.buildMigration=function(e){var t,r,n,i,o,a,s=e.schema,c=s.actual,u=s.expect;null===(r=null===(t=this.planner)||void 0===t?void 0:t.init)||void 0===r||r.call(t,e);var l=null!==(n=c.version)&&void 0!==n?n:0,h=null!==(i=u.version)&&void 0!==i?i:1;return null!==(a=null===(o=this.planner)||void 0===o?void 0:o.plan(l,h))&&void 0!==a?a:[]},e.prototype.executeSchemaMigration=function(e,t,r){var n,o,a,s;if(t)try{for(var c=Object(i.__values)(t),u=c.next();!u.done;u=c.next()){var l=u.value;try{for(var h=(a=void 0,Object(i.__values)(l.schema.actions)),p=h.next();!p.done;p=h.next()){var f=p.value;this.actionExecutor.executeSchemaAction(e,r,f)}}catch(e){a={error:e}}finally{try{p&&!p.done&&(s=h.return)&&s.call(h)}finally{if(a)throw a.error}}}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}},e.prototype.executeDataMigration=function(e,t,r){return Object(i.__awaiter)(this,void 0,void 0,(function(){var n,o,a,s,c,u,l,h,p,f,d,v;return Object(i.__generator)(this,(function(y){switch(y.label){case 0:if(!t)return[2];y.label=1;case 1:y.trys.push([1,12,13,14]),n=Object(i.__values)(t),o=n.next(),y.label=2;case 2:if(o.done)return[3,11];a=o.value,y.label=3;case 3:y.trys.push([3,8,9,10]),d=void 0,s=Object(i.__values)(a.data.actions),c=s.next(),y.label=4;case 4:return c.done?[3,7]:(u=c.value,[4,this.actionExecutor.executeDataAction(e,r,u)]);case 5:y.sent(),y.label=6;case 6:return c=s.next(),[3,4];case 7:return[3,10];case 8:return l=y.sent(),d={error:l},[3,10];case 9:try{c&&!c.done&&(v=s.return)&&v.call(s)}finally{if(d)throw d.error}return[7];case 10:return o=n.next(),[3,2];case 11:return[3,14];case 12:return h=y.sent(),p={error:h},[3,14];case 13:try{o&&!o.done&&(f=n.return)&&f.call(n)}finally{if(p)throw p.error}return[7];case 14:return[2]}}))}))},e.prototype.updateMigrationChangeInfo=function(e){var t,r;return Object(i.__awaiter)(this,void 0,void 0,(function(){var n,o;return Object(i.__generator)(this,(function(i){return n=this.schemaProvider.getDatabaseSchema(),o=null!==(t=n.version)&&void 0!==t?t:1,[2,Ke.updateSchemaChange(o,e,{schema:{expect:n,actual:null!==(r=this.actualDBSchema)&&void 0!==r?r:{name:n.name,collections:[]}}},"scan_exists_table"===this.actualDBSchemaFrom)]}))}))},e.prototype.log=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r]},e.prototype.executeDataUpgradeIfNeed=function(e,t){var r;return Object(i.__awaiter)(this,void 0,void 0,(function(){var n,o,a=this;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return this.log("executeDataUpgradeIfNeed",e.name),n=this.schemaProvider.getDatabaseSchema(),o={name:n.name,collections:[]},[4,this.lazyMigrationProcessor.executeDataUpgrade(e,t,{schema:{expect:n,actual:null!==(r=this.actualDBSchema)&&void 0!==r?r:o}},(function(){a.eventBus.emit(I.ModelLazyMigrationEnd,j.getTableName(e))}))];case 1:return i.sent(),[2]}}))}))},e.prototype.safeExecuteDataUpgrade=function(e,t){var r=this;Promise.all([e.waitForModelRegistered(t),e.waitForDBReady()]).then((function(e){var n=Object(i.__read)(e,2),o=n[0],a=n[1];r.executeDataUpgradeIfNeed(o.class,a).catch((function(e){r.emitError(new w(t,e))}))})).catch((function(){}))},e.prototype.emitError=function(e){this.eventBus.emit(D.Error,e)},e.prototype.applyAspectPatch=function(e){e.buildMigration.patch(this,"buildMigration"),e.executeDataMigration.patch(this,"executeDataMigration"),e.executeSchemaMigration.patch(this,"executeSchemaMigration"),e.prepareAutoUpgradeHandler.patch(this,"prepareAutoUpgradeHandler"),e.log.patch(this,"log"),e.updateMigrationChangeInfo.patch(this,"updateMigrationChangeInfo")},e}(),Je=Ye;var Xe=function(){var e;return{lock:function(t){return e||(e=t()),e.finally((function(){e=void 0}))}}},Ze=function(){function e(e,t){var r,n=this;if(this.openingMutex=Xe(),this.closingMutex=Xe(),this.destroyingMutex=Xe(),this.openDatabase=function(){return Object(i.__awaiter)(n,void 0,void 0,(function(){var e=this;return Object(i.__generator)(this,(function(t){return[2,this.openingMutex.lock((function(){return Object(i.__awaiter)(e,void 0,void 0,(function(){var e,t,r,n,o,a,c,u,l,h,p,f=this;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:if(this.db)return[2];e=this.storage,t=e.name,r=e.version,i.label=1;case 1:return i.trys.push([1,8,,9]),this.eventBus.emit(D.BootstrapStart),n=this.getDatabaseSchema(),[4,this.migrationManager.prepareAutoUpgradeHandler(t,this.engine)];case 2:o=i.sent(),a=function(){f.eventBus.emit(D.Fetal,new x(t))},i.label=3;case 3:return i.trys.push([3,5,,7]),c=this,[4,this.engine.openDB(t,n,r,{upgrade:o,terminated:a})];case 4:return c.db=i.sent(),[3,7];case 5:if("VersionError"!==(u=i.sent()).name||!this.supportCompatibleOpen)throw u;return l=this,[4,this.engine.openDB(t,n,void 0,{upgrade:o,terminated:a})];case 6:return l.db=i.sent(),[3,7];case 7:return this.db.setVersionChangeListener((function(e,t){f.eventBus.emit(D.VersionChange,{oldVersion:e,newVersion:t})})),this.eventBus.emit(D.BootstrapEnd),this.eventBus.emit(D.Ready,this.db),[3,9];case 8:throw h=i.sent(),this.reset(),p=new s(t,h),this.eventBus.emit(D.Error,p),this.eventBus.emit(D.Fetal,p),p;case 9:return[2]}}))}))}))]}))}))},this.handleModelRegistered=function(e){if(!n.schemas.some((function(t){return t.name===e.schema.name}))){var t=e.schema;t.dataVersion=n.storage.version,n.schemas.push(t)}},this.handleFetal=function(){n.reset()},this.storage=e,this.engine=t.engine,this.eventBus=t.eventBus,this.supportCompatibleOpen=t.supportCompatibleOpen,this.engine.setAspects(e.aspects.engine),this.schemas=[Ke.getSystemTableSchema()],t.databaseSchema){var o=JSON.parse(t.databaseSchema).collections.map((function(e){return Object(i.__assign)(Object(i.__assign)({},e),{dataVersion:n.storage.version})}));(r=this.schemas).push.apply(r,Object(i.__spreadArray)([],Object(i.__read)(o)))}this.migrationManager=new Je(this.eventBus,this,e.aspects.migration),this.eventBus.on(D.RegisterModel,this.handleModelRegistered),this.eventBus.on(D.Fetal,this.handleFetal)}return e.prototype.getDatabaseEngine=function(){return this.engine},e.prototype.getDatabaseSchema=function(){if(!this.storage.name||!this.storage.version)throw new Error("The database name and version are required for generating dbSchema");return{name:this.storage.name,version:this.storage.version,collections:this.schemas}},e.prototype.closeDatabase=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){var e=this;return Object(i.__generator)(this,(function(t){return[2,this.closingMutex.lock((function(){return Object(i.__awaiter)(e,void 0,void 0,(function(){return Object(i.__generator)(this,(function(e){switch(e.label){case 0:return this.db?[4,this.db.close()]:[2];case 1:return e.sent(),this.reset(),this.eventBus.emit(D.Closed),[2]}}))}))}))]}))}))},e.prototype.destroyDatabase=function(){var e=this;return this.destroyingMutex.lock((function(){return Object(i.__awaiter)(e,void 0,void 0,(function(){return Object(i.__generator)(this,(function(e){switch(e.label){case 0:return[4,this.engine.deleteDB(this.storage.name)];case 1:return e.sent(),this.reset(),this.eventBus.emit(D.Destroyed),[2]}}))}))}))},e.prototype.reset=function(){this.db=void 0},e}();var $e=function(e){return setTimeout(e)},et=function(){function e(e){var t=e.keepActive,r=e.comparer,n=e.channelDB,i=e.channelModel,o=e.channelLazyMigration;this.keepActive=t,this.comparer=r,this.channelDB=n,this.channelModel=i,this.channelLazyMigration=o}return e.fromTransactionManager=function(t,r){return void 0===r&&(r=!1),new e({keepActive:r,comparer:t.comparer,channelDB:t.channelDB,channelModel:t.channelModel,channelLazyMigration:t.channelLazyMigration})},e.prototype.prepareDBForTransaction=function(e,t){return Object(i.__awaiter)(this,void 0,void 0,(function(){var r=this;return Object(i.__generator)(this,(function(n){return this.transactionPreparePromise=Object(i.__awaiter)(r,void 0,void 0,(function(){var r,n=this;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return[4,Promise.all(e.map((function(e){return n.waitForModelRegistered(e)})))];case 1:return i.sent(),[4,Promise.all(e.map((function(e){return n.waitForMigrationReady(e)})))];case 2:return i.sent(),[4,this.waitForDBReady()];case 3:return r=i.sent(),[2,{startTransaction:function(){return n.transaction||(n.transaction=r.transaction(e,t)),n.transaction}}]}}))})),[2,this.transactionPreparePromise]}))}))},e.prototype.getTransactionGenerator=function(e,t){return Object(i.__awaiter)(this,void 0,void 0,(function(){return Object(i.__generator)(this,(function(r){switch(r.label){case 0:return this.transactionPreparePromise?[3,2]:[4,this.prepareDBForTransaction(e,t)];case 1:case 3:return[2,r.sent()];case 2:return[4,this.transactionPreparePromise]}}))}))},e.prototype.waitForDBReady=function(){return Object(i.__awaiter)(this,void 0,void 0,(function(){return Object(i.__generator)(this,(function(e){return[2,this.channelDB.pick()]}))}))},e.prototype.waitForModelRegistered=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){return Object(i.__generator)(this,(function(t){return[2,this.channelModel.pick(e)]}))}))},e.prototype.waitForMigrationReady=function(e){return Object(i.__awaiter)(this,void 0,void 0,(function(){return Object(i.__generator)(this,(function(t){return[2,this.channelLazyMigration.pick(e)]}))}))},e.prototype.perform=function(e){return this.keepActive?e():this.autoCommitOrRollback(e)},e.prototype.autoCommitOrRollback=function(e){var t,r;return Object(i.__awaiter)(this,void 0,void 0,(function(){var n,o;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,5]),[4,e()];case 1:return n=i.sent(),[4,null===(t=this.transaction)||void 0===t?void 0:t.commit()];case 2:return i.sent(),[2,n];case 3:return o=i.sent(),[4,null===(r=this.transaction)||void 0===r?void 0:r.rollback()];case 4:throw i.sent(),o;case 5:return[2]}}))}))},e}(),tt=Symbol("channel");var rt=function(e){var t;void 0===e&&(e=function(){return tt});var r=new Map,n=new Map;function o(e,t){var r;null===(r=n.get(e))||void 0===r||r.reject(t),n.delete(e)}function a(e,t){void 0===t&&(t=tt),n.has(t)?function(e,t){var r;null===(r=n.get(e))||void 0===r||r.resolve(t),n.delete(e)}(t,e):r.set(t,Promise.resolve(e))}return{send:function(r){t||a(r,e(r))},pick:function(e){return void 0===e&&(e=tt),t?Promise.reject(t):(r.has(e)||r.set(e,new Promise((function(t,r){n.set(e,{resolve:t,reject:r})}))),r.get(e))},open:function(){t=void 0},close:function(e,a){var s,c;void 0===a&&(a=!1),t=e;try{for(var u=Object(i.__values)(n.keys()),l=u.next();!l.done;l=u.next()){o(l.value,e)}}catch(e){s={error:e}}finally{try{l&&!l.done&&(c=u.return)&&c.call(u)}finally{if(s)throw s.error}}a&&(r.clear(),n.clear())}}},nt=function(){function e(e,t){var r=this;this.handleFetalError=function(e){r.channelDB.close(e,!0),r.channelModel.close(e),r.channelLazyMigration.close(e)},this.eventBus=e,this.channelDB=rt(),this.channelModel=rt((function(e){return e.schema.name})),this.channelLazyMigration=rt((function(e){return e})),this.comparer=t,this.eventBus.on(D.Fetal,this.handleFetalError),this.eventBus.on(D.Ready,this.channelDB.send),this.eventBus.on(D.RegisterModel,this.channelModel.send),this.eventBus.on(I.ModelLazyMigrationEnd,this.channelLazyMigration.send)}return e.prototype.spawnAutoCommitContext=function(){return et.fromTransactionManager(this,!1)},e.prototype.spawnKeepAliveContext=function(){return et.fromTransactionManager(this,!0)},e.prototype.openChannels=function(){this.channelDB.open(),this.channelModel.open(),this.channelLazyMigration.open()},e}(),it=function(){function e(e){var t,r=this,n=e.name,o=e.engine,a=e.version,s=void 0===a?1:a,c=e.plugins,u=void 0===c?[]:c,l=e.disableAutoOpen,h=void 0!==l&&l,p=e.databaseSchema,f=e.supportCompatibleOpen,d=void 0!==f&&f;this.aspects={collection:{get:Pe.a.withContext(Le),has:Pe.a.withContext(Le),delete:Pe.a.withContext(Le),insert:Pe.a.withContext(Le),upsert:Pe.a.withContext(Le),bulkInsert:Pe.a.withContext(Le),bulkUpsert:Pe.a.withContext(Le),update:Pe.a.withContext(Le),clear:Pe.a.withContext(Le),count:Pe.a.withContext(Le),entries:Pe.a.withContext(Le),keys:Pe.a.withContext(Le),values:Pe.a.withContext(Le),first:Pe.a.withContext(Le),last:Pe.a.withContext(Le),skip:Pe.b.withContext(Le),take:Pe.b.withContext(Le),slice:Pe.b.withContext(Le),orderBy:Pe.b.withContext(Le),where:Pe.b.withContext(Le),or:Pe.b.withContext(Le)},query:{},model:{},migration:{prepareAutoUpgradeHandler:Pe.a.withContext(Le),buildMigration:Pe.b.withContext(Le),executeDataMigration:Pe.a.withContext(Le),executeSchemaMigration:Pe.b.withContext(Le),updateMigrationChangeInfo:Pe.a.withContext(Le),log:Pe.b.withContext(Le),actionExecutor:{executeSchemaAction:Pe.b.withContext(Le),executeDataAction:Pe.a.withContext(Le)}},engine:{deleteDB:Pe.a.withContext(Le),openDB:Pe.a.withContext(Le),database:{createTable:Pe.b.withContext(Le),deleteTable:Pe.b.withContext(Le),close:Pe.b.withContext(Le),table:Pe.a.withContext(Le),transaction:Pe.b.withContext(Le)},table:{createIndex:Pe.a.withContext(Le),deleteIndex:Pe.a.withContext(Le),delete:Pe.a.withContext(Le),get:Pe.a.withContext(Le),getAll:Pe.a.withContext(Le),getAllKeys:Pe.a.withContext(Le),index:Pe.b.withContext(Le),insert:Pe.a.withContext(Le),query:Pe.a.withContext(Le),openCursor:Pe.a.withContext(Le),upsert:Pe.a.withContext(Le),bulkUpsert:Pe.a.withContext(Le),clear:Pe.a.withContext(Le),bulkDelete:Pe.a.withContext(Le)},index:{get:Pe.a.withContext(Le),getAll:Pe.a.withContext(Le),getAllKeys:Pe.a.withContext(Le),openCursor:Pe.a.withContext(Le)},cursor:{delete:Pe.a.withContext(Le),update:Pe.a.withContext(Le),next:Pe.a.withContext(Le),value:Pe.b.withContext(Le)},transaction:{commit:Pe.a.withContext(Le),rollback:Pe.a.withContext(Le),table:Pe.b.withContext(Le)}}},this.eventBus=S(),this.open=function(){return r.transactionManager.openChannels(),r.databaseManager.openDatabase()},this.close=function(){return r.databaseManager.closeDatabase()},this.destroy=function(){return r.databaseManager.destroyDatabase()},this.register=function(e){r.modelManager.register(e)},this.collection=function(e){var t=r.modelManager.getSchemaAndRegisterModelIfNeed(e);return r.collectionManager.getCollection(t.name,{spawnContext:function(){return r.transactionManager.spawnAutoCommitContext()}})},this.transaction=function(e,t,n){return Object(i.__awaiter)(r,void 0,void 0,(function(){var r,o,a,s=this;return Object(i.__generator)(this,(function(i){switch(i.label){case 0:return r=this.transactionManager,o=e.map((function(e){return s.modelManager.getSchemaAndRegisterModelIfNeed(e).name})),a=r.spawnKeepAliveContext(),this.eventBus.emit(I.StartTransaction,{collectionNames:o,context:a}),[4,a.getTransactionGenerator(o,t)];case 1:return i.sent().startTransaction(),[2,a.autoCommitOrRollback((function(){return n(s.createStorageTransaction(a))}))]}}))}))},this.name=n,this.version=s,this.events=new T(this.eventBus),this.modelManager=new R(this.eventBus),this.databaseManager=new Ze(this,{engine:o,eventBus:this.eventBus,databaseSchema:p,supportCompatibleOpen:d}),this.pluginManager=new Ve(this,this.eventBus),this.collectionManager=new ke(this,this.eventBus),this.transactionManager=new nt(this.eventBus,{cmp:this.databaseManager.getDatabaseEngine().cmp}),(t=this.pluginManager).add.apply(t,Object(i.__spreadArray)([],Object(i.__read)(u))),h||$e((function(){return r.open().catch((function(e){throw e}))}))}return e.prototype.createStorageTransaction=function(e){var t=this.modelManager,r=new ke(this,this.eventBus);return{collection:function(n){var i=t.getSchemaAndRegisterModelIfNeed(n);return r.getCollection(i.name,{spawnContext:function(){return e}})}}},e}();t.default=it},"5d64cf765d":function(e,t,r){"use strict";var n,i;r.d(t,"g",(function(){return n})),r.d(t,"a",(function(){return i})),r.d(t,"d",(function(){return a})),r.d(t,"l",(function(){return o})),r.d(t,"k",(function(){return p})),r.d(t,"f",(function(){return s})),r.d(t,"e",(function(){return c})),r.d(t,"i",(function(){return u})),r.d(t,"c",(function(){return l})),r.d(t,"b",(function(){return h})),r.d(t,"o",(function(){return f})),r.d(t,"n",(function(){return d})),r.d(t,"m",(function(){return v})),r.d(t,"h",(function(){return g})),r.d(t,"j",(function(){return y})),function(e){e.CreateCollection="create-collection",e.DropCollection="drop-collection",e.CreateIndex="create-index",e.DropIndex="drop-index"}(n||(n={})),function(e){e.MoveProperty="move-property",e.DropProperty="drop-property",e.ReplaceProperty="replace-property",e.ClearData="clear-data",e.ReplaceData="replace-data"}(i||(i={}));var o,a={name:"alloy_db_schema_table",indices:[],key:{path:"name"},properties:[]};!function(e){e.Equals="=",e.NotEquals="!=",e.GreaterThan=">",e.GreaterOrEqualThan=">=",e.LessThan="<",e.LessOrEqualThan="<=",e.In="in",e.NotIn="nin"}(o||(o={}));var s,c,u,l,h,p=void 0;function f(e){return"number"==typeof e&&!Number.isNaN(e)||"string"==typeof e||e instanceof Date&&!Number.isNaN(e.getTime())||e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Array.isArray(e)&&e.every(f)}function d(e,t){var r=e;return Array.isArray(t)?t.map((function(e){return r[e]})):r[t]}function v(e,t){return Array.isArray(e)?Array.isArray(t)&&e.length===t.length&&e.every((function(e,r){return v(e,t[r])})):e===t}!function(e){e.OR="or",e.AND="and",e.FILTER="filter",e.NONE="none",e.ALL="all"}(s||(s={})),function(e){e.ENTRIES="entries",e.VALUES="values",e.KEYS="keys",e.COUNT="count"}(c||(c={})),function(e){e.DESCENDING="desc",e.ASCENDING="asc"}(u||(u={})),function(e){e.AutoIncrement="auto-increment"}(l||(l={})),function(e){e.Equals="=",e.GreaterThan=">",e.GreaterOrEqualThan=">=",e.LessThan="<",e.LessOrEqualThan="<="}(h||(h={}));var y,b=r("d7c625d1f2"),g=function(){function e(){}return e.collectionDiff=function(e,t){if(e.name!==t.name)throw new Error("can not compare collection schema with different name");var r={collection:e.name},n=t.indices.filter((function(t){return!e.indices.some((function(e){return e.name===t.name}))})),i=e.indices.filter((function(e){return!t.indices.some((function(t){return t.name===e.name}))}));return(n.length||i.length)&&(r.index={added:Object(b.__spreadArray)([],Object(b.__read)(n)),deleted:Object(b.__spreadArray)([],Object(b.__read)(i))}),r},e.databaseDiff=function(e,t){var r,n,i=this.getCompareMap(e,t),o={added:[],deleted:[],different:[]};try{for(var a=Object(b.__values)(i.values()),s=a.next();!s.done;s=a.next()){var c=s.value;if(!c.oldValue||c.newValue)if(c.oldValue||!c.newValue){if(c.oldValue&&c.newValue){var u=this.collectionDiff(c.oldValue,c.newValue);if(!u.index)continue;o.different.push(u)}}else o.added.push(c.newValue);else o.deleted.push(c.oldValue)}}catch(e){r={error:e}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return o},e.getCompareMap=function(e,t){var r,n,i,o,a=new Map;try{for(var s=Object(b.__values)(t.collections),c=s.next();!c.done;c=s.next()){var u=c.value;(p=a.get(u.name)||{}).newValue=u,a.set(u.name,p)}}catch(e){r={error:e}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}try{for(var l=Object(b.__values)(e.collections),h=l.next();!h.done;h=l.next()){var p;u=h.value;(p=a.get(u.name)||{}).oldValue=u,a.set(u.name,p)}}catch(e){i={error:e}}finally{try{h&&!h.done&&(o=l.return)&&o.call(l)}finally{if(i)throw i.error}}return a},e}();!function(e){e.READ_ONLY="readonly",e.READ_WRITE="readwrite",e.VERSION_CHANGE="versionchange"}(y||(y={}))},"7b66f04f1e":function(e,t,r){"use strict";r.d(t,"a",(function(){return o})),r.d(t,"b",(function(){return a})),r.d(t,"c",(function(){return s}));var n=r("d7c625d1f2"),i=function(e){function t(t,r){for(var n=this,i=t,o={cause:r};o.cause&&o.cause instanceof Error;)i=t+"\n\t→ "+r,o=o.cause;return(n=e.call(this,i)||this).cause=r,n.name=n.constructor.name,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(n,n.constructor):n.stack=(new Error).stack,Object.setPrototypeOf(n,n.constructor.prototype),n}return Object(n.__extends)(t,e),t}(Error),o={withDefaultMessage:function(e,t){return function(r){function i(n,i){var o=r.call(this,n||t||"",i)||this;return o.name=e,Object.setPrototypeOf(o,o.constructor.prototype),o}return Object(n.__extends)(i,r),i}(i)},withMessageCreator:function(e,t){return function(r){function i(n,i){var o=r.call(this,t(n),i)||this;return o.name=e,Object.setPrototypeOf(o,o.constructor.prototype),o}return Object(n.__extends)(i,r),i}(i)}},a=(o.withDefaultMessage("AssertionError","the asserted condition is invalid"),o.withMessageCreator("UnimplementedError",(function(e){return e?"called with arguments: "+JSON.stringify(e):"called with nothing"})));var s=function(e){0}},e93cc9d9b1:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var n=r("d7c625d1f2"),i=r("5d64cf765d"),o=r("7b66f04f1e"),a=o.a.withMessageCreator("UnexpectedOutsideMigrationActionError",(function(e){return e+" outside ensure(callback) is not allowed, please wrap your migration actions inside a ensure callback"})),s=function(){function e(e,t){this.name=e,this.context=t}return e.create=function(t){return{index:function(r){return new e(r,t)}}},e.prototype.create=function(e){var t=this.context.scope.collection;if(!t)throw new a("CreateIndex");return this.context.actions.schema.push({type:i.g.CreateIndex,name:this.name,attributes:Object(n.__assign)({},e),collection:t}),this},e.prototype.drop=function(){var e=this.context.scope.collection;if(!e)throw new a("DropIndex");this.context.actions.schema.push({type:i.g.DropIndex,name:this.name,collection:e})},e.prototype.alter=function(e){var t=this.context.scope.collection;if(!t)throw new a("AlterIndex");return this.context.actions.schema.push({type:i.g.DropIndex,name:this.name,collection:t},{type:i.g.CreateIndex,name:this.name,attributes:Object(n.__assign)({},e),collection:t}),this},e.prototype.rename=function(e){var t=this.context.scope.collection;if(!t)throw new a("RenameIndex");this.context.actions.schema.push({type:i.g.DropIndex,name:this.name,collection:t},{type:i.g.CreateIndex,name:e,attributes:{path:""},collection:t})},e.prototype.ensure=function(){throw new o.b},e}(),c=function(){function e(e,t){this.name=e,this.context=t}return e.create=function(t){return{collection:function(r){return new e(r,t)}}},e.prototype.create=function(e){return this.context.actions.schema.push({type:i.g.CreateCollection,name:this.name,attributes:Object(n.__assign)({},e)}),this},e.prototype.drop=function(){this.context.actions.schema.push({type:i.g.DropCollection,name:this.name})},e.prototype.alter=function(e){return this.context.actions.schema.push({type:i.g.DropCollection,name:this.name},{type:i.g.CreateCollection,name:this.name,attributes:Object(n.__assign)({},e)}),this},e.prototype.rename=function(e){this.context.actions.schema.push({type:i.g.DropCollection,name:this.name},{type:i.g.CreateCollection,name:e,attributes:{key:{generator:i.c.AutoIncrement},properties:[]}})},e.prototype.ensure=function(e){var t=this.context,r=Object(n.__assign)({},s.create(t));this.context.scope.collection=this.name,e(r),this.context.scope.collection=null},e}(),u=function(){function e(){this.context={actions:{schema:[],data:[]},scope:{database:null,collection:null}},this.builder=c.create(this.context)}return e.prototype.init=function(e){this.state=e,this.build()},e.prototype.plan=function(){return this.context.actions.schema.length||this.context.actions.data.length?[{schema:{actions:this.context.actions.schema.slice()},data:{actions:this.context.actions.data.slice()}}]:[]},e.prototype.handleDropCollection=function(e){var t,r;try{for(var i=Object(n.__values)(e),o=i.next();!o.done;o=i.next()){var a=o.value;this.builder.collection(a.name).drop()}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}},e.prototype.handleCreateCollection=function(e){var t,r,i=function(e){o.builder.collection(e.name).create(e).ensure((function(t){var r,i;try{for(var o=(r=void 0,Object(n.__values)(e.indices)),a=o.next();!a.done;a=o.next()){var s=a.value;t.index(s.name).create(s)}}catch(e){r={error:e}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}}))},o=this;try{for(var a=Object(n.__values)(e),s=a.next();!s.done;s=a.next()){i(s.value)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}},e.prototype.handleIndexChange=function(e){var t,r,i=function(e){o.builder.collection(e.collection).ensure((function(t){var r,i,o,a,s,c;try{for(var u=(r=void 0,Object(n.__values)((null===(s=e.index)||void 0===s?void 0:s.added)||[])),l=u.next();!l.done;l=u.next()){var h=l.value;t.index(h.name).create(h)}}catch(e){r={error:e}}finally{try{l&&!l.done&&(i=u.return)&&i.call(u)}finally{if(r)throw r.error}}try{for(var p=(o=void 0,Object(n.__values)((null===(c=e.index)||void 0===c?void 0:c.deleted)||[])),f=p.next();!f.done;f=p.next()){h=f.value;t.index(h.name).drop()}}catch(e){o={error:e}}finally{try{f&&!f.done&&(a=p.return)&&a.call(p)}finally{if(o)throw o.error}}}))},o=this;try{for(var a=Object(n.__values)(e),s=a.next();!s.done;s=a.next()){i(s.value)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}},e.prototype.build=function(){if(!this.state)throw new Error("Migration state is undefined, must init before!");var e=this.state.schema,t=e.expect,r=e.actual,n=i.h.databaseDiff(r,t);this.handleCreateCollection(n.added),this.handleDropCollection(n.deleted),this.handleIndexChange(n.different)},e}()}}]);
//# sourceMappingURL=slide-14-a22732.js.map